<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Estoque com An√°lise Preditiva - Borracha</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .header h1 {
            margin: 0;
            flex: 1;
            min-width: 300px;
        }
        
        .company-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            max-width: 300px;
            height: 60px;
        }
        
        .company-logo img {
            max-height: 100%;
            max-width: 100%;
            object-fit: contain;
        }
        
        .search-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }
        
        .search-container {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .search-input {
            flex: 1;
            min-width: 300px;
            padding: 12px 20px;
            border: 2px solid #1F448C;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: all 0.3s ease;
        }
        
        .search-input:focus {
            box-shadow: 0 0 0 3px rgba(31, 68, 140, 0.1);
            transform: translateY(-1px);
        }
        
        .search-results {
            margin-top: 10px;
            font-size: 14px;
            color: #666;
        }
        
        .controls {
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        button {
            background-color: #1F448C;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        
        button:hover {
            background-color: #163666;
            transform: translateY(-1px);
        }
        
        button.active {
            background-color: #2196F3;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.3);
        }

        button.btn-auto-save {
            background-color: #28a745;
            position: relative;
        }

        button.btn-auto-save:hover {
            background-color: #218838;
        }

        button.btn-auto-save.ready {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
        }

        .btn-download-highlight {
            background-color: #28a745 !important;
            box-shadow: 0 0 0 4px rgba(40, 167, 69, 0.3);
            transform: scale(1.05);
        }
        
        select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s ease;
            min-width: 180px;
        }
        
        select:focus {
            border-color: #1F448C;
            outline: none;
        }
        
        .import-section {
            background: #e3f2fd;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #bbdefb;
        }
        
        .import-header {
            padding: 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
            transition: background-color 0.3s ease;
        }
        
        .import-header:hover {
            background-color: #d1e7fd;
        }
        
        .import-content {
            padding: 0 15px 15px 15px;
            display: none;
            transition: all 0.3s ease;
        }
        
        .import-content.expanded {
            display: block !important;
        }
        
        .toggle-icon {
            transition: transform 0.3s ease;
            font-size: 18px;
        }
        
        .toggle-icon.expanded {
            transform: rotate(180deg);
        }
        
        .file-input {
            margin: 10px 0;
        }
        
        input[type="file"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .analytics-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .prediction-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .prediction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            border-bottom: 1px solid #eee;
            transition: all 0.3s ease;
        }

        .prediction-item.clickable {
            cursor: pointer;
            border-radius: 5px;
        }

        .prediction-item.clickable:hover {
            background-color: #f8f9fa;
            transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .prediction-item.active {
            background-color: #e3f2fd;
            border-left: 4px solid #1F448C;
        }
        
        .prediction-item:last-child {
            border-bottom: none;
        }
        
        .prediction-label {
            font-weight: bold;
            color: #333;
        }
        
        .prediction-value {
            color: #1F448C;
            font-weight: bold;
        }
        
        .prediction-critical {
            color: #dc3545;
        }
        
        .prediction-warning {
            color: #ffc107;
        }
        
        .prediction-good {
            color: #28a745;
        }
        
        .gauges-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .gauge-card {
            background: #fff;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
        }
        
        .gauge-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
            border-color: #1F448C;
        }
        
        .gauge-card.selected {
            border: 2px solid #1F448C;
            background-color: #f8f9ff;
            box-shadow: 0 4px 16px rgba(31, 68, 140, 0.3);
        }
        
        .gauge-card.highlighted {
            border: 2px solid #1F448C;
            box-shadow: 0 4px 16px rgba(31, 68, 140, 0.3);
        }
        
        .gauge {
            position: relative;
            width: 240px;
            height: 140px;
            margin: 0 auto;
        }
        
        .gauge-title {
            text-align: center;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }
        
        .gauge-value {
            position: absolute;
            top: 70%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        
        .gauge-label {
            position: absolute;
            top: 85%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            color: #666;
        }
        
        .products-table {
            margin-top: 30px;
        }
        
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .table-container {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .tooltip-container {
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            cursor: help;
        }

        .tooltip-container:focus {
            outline: 2px solid rgba(31, 68, 140, 0.4);
            outline-offset: 2px;
        }

        .tooltip-bubble {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            bottom: calc(100% + 10px);
            left: 50%;
            transform: translateX(-50%);
            background: #1F448C;
            color: #fff;
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 12px;
            line-height: 1.4;
            white-space: normal;
            width: max-content;
            max-width: 260px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            transition: opacity 0.2s ease, visibility 0.2s ease;
            pointer-events: none;
            z-index: 5;
        }

        .tooltip-bubble::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border-width: 6px;
            border-style: solid;
            border-color: #1F448C transparent transparent transparent;
        }

        .tooltip-container:hover .tooltip-bubble,
        .tooltip-container:focus .tooltip-bubble,
        .tooltip-container:focus-within .tooltip-bubble {
            visibility: visible;
            opacity: 1;
        }

        .info-tooltip {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #1F448C;
            color: #fff;
            font-size: 12px;
            font-weight: 700;
            align-items: center;
            justify-content: center;
            display: inline-flex;
        }

        .info-tooltip .tooltip-bubble {
            bottom: calc(100% + 12px);
        }

        .info-tooltip-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }

        .tooltip-chip {
            padding: 4px 10px;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.7);
            font-weight: 600;
            gap: 4px;
        }

        .tooltip-chip .tooltip-bubble {
            left: 0;
            transform: translateX(-20%);
        }

        .tooltip-chip .tooltip-bubble::after {
            left: 20%;
        }

        .tooltip-hint {
            font-size: 11px;
            font-weight: 700;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.6);
            color: inherit;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        th {
            background-color: #f8f9fa;
            font-weight: bold;
            color: #333;
            padding: 12px 8px;
            text-align: left;
            position: sticky;
            top: 0;
            border-bottom: 2px solid #ddd;
        }

        th .th-content {
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        td {
            padding: 8px;
            border-bottom: 1px solid #eee;
        }
        
        tr:hover {
            background-color: #f8f9fa;
        }
        
        tr.highlighted {
            background-color: #e3f2fd !important;
            border-left: 4px solid #1F448C;
        }
        
        .status-critical {
            background-color: #ffebee !important;
            color: #c62828;
            font-weight: bold;
        }
        
        .status-warning {
            background-color: #fff8e1 !important;
            color: #f57c00;
        }
        
        .status-good {
            background-color: #e8f5e8 !important;
            color: #2e7d32;
        }

        .status-unknown {
            background-color: #f1f3f4 !important;
            color: #5f6368;
        }

        .summary-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .pareto-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
        }

        .pareto-section h3 {
            margin-top: 0;
            margin-bottom: 15px;
        }

        .pareto-table {
            width: 100%;
            border-collapse: collapse;
        }

        .pareto-table th,
        .pareto-table td {
            text-align: left;
            padding: 10px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 13px;
        }

        .pareto-table th {
            background: #e3f2fd;
            color: #1F448C;
        }

        .pareto-empty {
            margin: 0;
            color: #666;
            text-align: center;
            font-size: 14px;
        }

        .abc-chip {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 32px;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 12px;
            color: #fff;
        }

        .abc-chip.abc-a {
            background-color: #f44336;
        }

        .abc-chip.abc-b {
            background-color: #ff9800;
        }

        .abc-chip.abc-c {
            background-color: #4caf50;
        }

        tr.abc-row-a {
            box-shadow: inset 4px 0 0 #f44336;
        }

        tr.abc-row-b {
            box-shadow: inset 4px 0 0 #ff9800;
        }

        tr.abc-row-c {
            box-shadow: inset 4px 0 0 #4caf50;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .stat-item.clickable {
            cursor: pointer;
        }
        
        .stat-item.clickable:hover {
            background-color: #ffebee;
            border-color: #f44336;
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.2);
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #1F448C;
        }
        
        .stat-value.critical {
            color: #f44336;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .close {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #999;
        }
        
        .close:hover {
            color: #333;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .btn-secondary {
            background-color: #6c757d;
        }
        
        .btn-secondary:hover {
            background-color: #545b62;
        }

        .success-message {
            background-color: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid #c3e6cb;
        }

        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid #f5c6cb;
        }

        .warning-message {
            background-color: #fff3cd;
            color: #856404;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid #ffeaa7;
        }

        .info-message {
            background-color: #d1ecf1;
            color: #0c5460;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid #bee5eb;
        }

        .offline-notice {
            background: #e3f2fd;
            border: 2px solid #2196F3;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .browser-mode-indicator {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 8px 12px;
            margin: 10px 0;
            font-size: 14px;
        }

        .download-section {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .debug-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }

        .mapping-debug {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }

        @keyframes gaugeAnimation {
            from {
                transform: scale(0.8);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .gauge-card.animating {
            animation: gaugeAnimation 0.6s ease-out;
        }

        @keyframes highlight {
            0% { background-color: transparent; }
            50% { background-color: rgba(31, 68, 140, 0.1); }
            100% { background-color: transparent; }
        }

        .highlight-animation {
            animation: highlight 1s ease-in-out;
        }

        /* Responsividade para mobile */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
                margin: 10px;
            }
            
            .header {
                flex-direction: column;
                align-items: stretch;
                text-align: center;
            }
            
            .header h1 {
                min-width: auto;
                margin-bottom: 10px;
            }
            
            .company-logo {
                justify-content: center;
                font-size: 20px;
            }
            
            .search-input {
                min-width: 200px;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .control-group {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }
            
            .control-group label {
                font-weight: bold;
                margin-bottom: 5px;
            }
            
            .summary-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .stat-item {
                padding: 10px;
            }
            
            .stat-value {
                font-size: 20px;
            }
            
            .gauges-container {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .gauge {
                width: 200px;
                height: 120px;
            }
            
            .table-container {
                font-size: 12px;
            }
            
            th, td {
                padding: 6px 4px;
            }
        }

        @media (max-width: 480px) {
            .summary-stats {
                grid-template-columns: 1fr;
            }
            
            .gauge {
                width: 180px;
                height: 100px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Dashboard de Estoque - Borracha</h1>
            <div class="company-logo">
                <img src="https://usiquimica.com.br/wp-content/uploads/2022/05/usiquimica-logo-horizontal-1.png" alt="USIQUIMICA" />
            </div>
        </div>
        
        <div class="import-section">
            <div class="import-header" onclick="toggleImportSection()">
                <h3>üìä Importar Dados da Planilha</h3>
                <span class="toggle-icon" id="toggleIcon">‚ñº</span>
            </div>
            <div class="import-content" id="importContent">
                <div class="offline-notice">
                    <strong>üåê Modo Offline</strong> - Este dashboard funciona sem servidor! 
                    Importe suas planilhas e compartilhe os arquivos atualizados com sua equipe.
                    <div class="browser-mode-indicator" id="browserModeIndicator">
                        üîç Detectando modo do navegador...
                    </div>
                </div>
                
                <div class="file-input">
                    <input type="file" id="excelFile" accept=".xlsx,.xls,.csv" />
                    <button onclick="importData()">Importar Planilha</button>
                    <button onclick="tryAutoSave()" id="autoSaveBtn" class="btn-auto-save" style="display: none;">‚ú® Configurar Pasta</button>
                    <button onclick="reconfigureAutoSave()" id="reconfigBtn" style="display: none; background-color: #6c757d;">üîß Reconfigurar</button>
                    <button onclick="openTemplateGenerator()" style="background-color: #28a745;">üìã Template</button>
                </div>
                <div id="importMessages"></div>
                <div id="mappingDebug" class="mapping-debug" style="display: none;"></div>
                <div id="lastUpdateInfo" style="font-size: 12px; color: #666; margin: 10px 0;"></div>
                <div id="debugInfo" class="debug-info" style="display: none;"></div>
                <small><strong>v1.2 - Mapeamento Corrigido:</strong> Agora identifica corretamente colunas como TOTAL, ESTOQUE TOTAL, SOMA, etc. As colunas devem conter: C√ìDIGO, FORNECEDOR, FAM√çLIA, ITEM, 1-4, 90-13, 90-15, ESTOQUE EM MESES, VENDAS 3M, M√âDIA 3M</small>
                
                <div class="download-section">
                    <h4>üìã Compartilhar Dados</h4>
                    <p>Ap√≥s importar, baixe o arquivo de dados atualizado e compartilhe com sua equipe:</p>
                    <button onclick="downloadDataFile()" style="background-color: #28a745; font-size: 16px; padding: 10px 20px;">üíæ Baixar data.js Atualizado</button>
                    <button onclick="testAutoSave()" id="testBtn" style="display: none; background-color: #17a2b8; margin-left: 10px;">üß™ Testar</button>
                    <button onclick="runDiagnostic()" style="background-color: #6c757d; margin-left: 10px;">üîç Diagn√≥stico</button>
                    <button onclick="toggleDebug()" style="background-color: #ffc107; margin-left: 10px;">üêõ Debug</button>
                    <button onclick="toggleMappingDebug()" style="background-color: #17a2b8; margin-left: 10px;">üìã Mapeamento</button>
                    <br><br>
                    <div style="background: #e8f4fd; padding: 12px; border-radius: 6px; border-left: 4px solid #0066cc;">
                        <strong>üîç Como compartilhar seus dados:</strong><br>
                        1. Clique em "üíæ Baixar data.js Atualizado" ap√≥s importar<br>
                        2. Substitua o arquivo <code>data.js</code> na pasta compartilhada<br>
                        3. Todos que acessarem o dashboard ver√£o os dados atualizados
                    </div>
                </div>
            </div>
        </div>

        <div class="search-section">
            <div class="search-container">
                <input 
                    type="text" 
                    id="globalSearch" 
                    class="search-input" 
                    placeholder="üîç Buscar por c√≥digo ou nome do produto..."
                />
                <button class="clear-search" onclick="clearSearch()">üóëÔ∏è Limpar</button>
            </div>
            <div class="search-results" id="searchResults"></div>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <label>Filtrar por:</label>
                <button onclick="showAllProducts()" class="filter-btn active" data-filter="all">Todos</button>
                <button onclick="filterCriticalStock()" class="filter-btn" data-filter="critical">Estoque Cr√≠tico (&lt;2m)</button>
                <button onclick="filterLowStock()" class="filter-btn" data-filter="low">Estoque Baixo (2-6m)</button>
                <button onclick="filterHighStock()" class="filter-btn" data-filter="high">Slow Moving (&gt;6m)</button>
            </div>
            
            <div class="control-group">
                <label>Fam√≠lia:</label>
                <select id="familyFilter" onchange="filterByFamily()">
                    <option value="">Todas as Fam√≠lias</option>
                </select>
            </div>

            <div class="control-group">
                <label>Fornecedor:</label>
                <select id="supplierFilter" onchange="filterBySupplier()">
                    <option value="">Todos os Fornecedores</option>
                </select>
            </div>

            <div class="control-group">
                <label>Estabelecimento:</label>
                <select id="establishmentFilter" onchange="filterByEstablishment()">
                    <option value="">Todos os Estabelecimentos</option>
                    <option value="1-4">1-4 (GUARULHOS)</option>
                    <option value="90-13">90-13 (ITAJA√ç)</option>
                    <option value="90-15">90-15 (GARUVA)</option>
                </select>
            </div>

            <div class="control-group">
                <label>Filtro avan√ßado:</label>
                <select id="advancedStockFilter" onchange="filterByAdvancedStock()">
                    <option value="">Todos os produtos</option>
                    <option value="no-stock">Sem estoque</option>
                    <option value="over50">Estoque &gt; 50 meses</option>
                </select>
            </div>

            <div class="control-group">
                <button onclick="showExportModal()">üì§ Exportar</button>
                <button onclick="updateData()">üîÑ Atualizar</button>
            </div>
        </div>

        <div class="analytics-section">
            <h3>üîÆ An√°lise Preditiva</h3>
            <div class="prediction-card" style="max-width: 600px; margin: 0 auto;">
                <h4>‚ö†Ô∏è Alertas Preditivos</h4>
                <div id="predictionAlerts">
                    <div class="prediction-item clickable" onclick="filterZeroIn30()" title="Clique para filtrar produtos">
                        <span class="prediction-label">Produtos zerando em <span id="urgentDaysLabel">30</span> dias:</span>
                        <span class="prediction-value prediction-critical" id="zeroIn30">0</span>
                    </div>
                    <div class="prediction-item clickable" onclick="filterZeroIn60()" title="Clique para filtrar produtos">
                        <span class="prediction-label">Produtos zerando em <span id="warningDaysLabel">60</span> dias:</span>
                        <span class="prediction-value prediction-warning" id="zeroIn60">0</span>
                    </div>
                    <div class="prediction-item">
                        <span class="prediction-label">Ponto de reposi√ß√£o ideal:</span>
                        <span class="prediction-value prediction-good" id="reorderPoint">--</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="summary-card">
            <h3>Resumo Geral
                <span class="tooltip-container info-tooltip" tabindex="0" aria-label="Explica√ß√£o sobre o resumo geral">
                    <span class="info-tooltip-icon" aria-hidden="true">?</span>
                    <span class="tooltip-bubble">Indicadores de cobertura que mostram quantidade de produtos, estoque m√©dio e medidas de dispers√£o (mediana, quartis e desvio-padr√£o) para detectar concentra√ß√µes e outliers, al√©m do total de fam√≠lias e itens cr√≠ticos.</span>
                </span>
            </h3>
            <div class="summary-stats">
                <div class="stat-item">
                    <div class="stat-value" id="totalProducts">0</div>
                    <div class="stat-label">Total de Produtos</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="avgStockMonths">0.0</div>
                    <div class="stat-label">M√©dia de Estoque (meses)</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="medianStock">--</div>
                    <div class="stat-label">Mediana de Estoque (meses)</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="q1Stock">--</div>
                    <div class="stat-label">1¬∫ Quartil (25%)</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="q3Stock">--</div>
                    <div class="stat-label">3¬∫ Quartil (75%)</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="stdDevStock">--</div>
                    <div class="stat-label">Desvio-Padr√£o (meses)</div>
                </div>
                <div class="stat-item clickable" onclick="filterCriticalStock()" title="Clique para ver produtos cr√≠ticos (<2 meses)">
                    <div class="stat-value critical" id="criticalCount">0</div>
                    <div class="stat-label">Produtos Cr√≠ticos</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalFamilies">0</div>
                    <div class="stat-label">Fam√≠lias de Produtos</div>
                </div>
            </div>
        </div>
        
        <div class="pareto-section">
            <h3>üìä An√°lise ABC por Vendas
                <span class="tooltip-container info-tooltip" tabindex="0" aria-label="Como funciona a an√°lise ABC">
                    <span class="info-tooltip-icon" aria-hidden="true">?</span>
                    <span class="tooltip-bubble">Classifica√ß√£o dos itens conforme a participa√ß√£o nas vendas acumuladas: Classe A concentra ~80% do faturamento (itens estrat√©gicos), Classe B cobre a faixa intermedi√°ria (at√© ~95%) e Classe C agrupa os itens de menor giro.</span>
                </span>
            </h3>
            <div id="paretoContent"></div>
        </div>
        <div class="gauges-container" id="gaugesContainer">
        </div>
        
        <div class="products-table">
            <div class="table-header">
                <h3>Detalhes dos Produtos</h3>
                <span id="tableCount">0 produtos exibidos</span>
            </div>
            <div class="table-container">
                <table id="productsTable">
                    <thead>
                        <tr>
                            <th>
                                <span class="th-content">C√≥digo
                                    <span class="tooltip-container info-tooltip" tabindex="0" aria-label="O que √© o c√≥digo do produto?">
                                        <span class="info-tooltip-icon" aria-hidden="true">?</span>
                                        <span class="tooltip-bubble">Identificador interno √∫nico de cada item no cadastro.</span>
                                    </span>
                                </span>
                            </th>
                            <th>
                                <span class="th-content">Fornecedor
                                    <span class="tooltip-container info-tooltip" tabindex="0" aria-label="Quem √© o fornecedor?">
                                        <span class="info-tooltip-icon" aria-hidden="true">?</span>
                                        <span class="tooltip-bubble">Parceiro respons√°vel pelo fornecimento do produto.</span>
                                    </span>
                                </span>
                            </th>
                            <th>
                                <span class="th-content">Fam√≠lia
                                    <span class="tooltip-container info-tooltip" tabindex="0" aria-label="O que significa fam√≠lia?">
                                        <span class="info-tooltip-icon" aria-hidden="true">?</span>
                                        <span class="tooltip-bubble">Categoria ou agrupamento ao qual o item pertence.</span>
                                    </span>
                                </span>
                            </th>
                            <th>
                                <span class="th-content">Item
                                    <span class="tooltip-container info-tooltip" tabindex="0" aria-label="Descri√ß√£o do item">
                                        <span class="info-tooltip-icon" aria-hidden="true">?</span>
                                        <span class="tooltip-bubble">Nome completo ou descri√ß√£o comercial do produto.</span>
                                    </span>
                                </span>
                            </th>
                            <th>
                                <span class="th-content">Est. 1-4
                                    <span class="tooltip-container info-tooltip" tabindex="0" aria-label="Estoque na unidade 1-4">
                                        <span class="info-tooltip-icon" aria-hidden="true">?</span>
                                        <span class="tooltip-bubble">Saldo dispon√≠vel no estabelecimento 1-4 (Guarulhos).</span>
                                    </span>
                                </span>
                            </th>
                            <th>
                                <span class="th-content">Est. 90-13
                                    <span class="tooltip-container info-tooltip" tabindex="0" aria-label="Estoque na unidade 90-13">
                                        <span class="info-tooltip-icon" aria-hidden="true">?</span>
                                        <span class="tooltip-bubble">Saldo dispon√≠vel no estabelecimento 90-13 (Itaja√≠).</span>
                                    </span>
                                </span>
                            </th>
                            <th>
                                <span class="th-content">Est. 90-15
                                    <span class="tooltip-container info-tooltip" tabindex="0" aria-label="Estoque na unidade 90-15">
                                        <span class="info-tooltip-icon" aria-hidden="true">?</span>
                                        <span class="tooltip-bubble">Saldo dispon√≠vel no estabelecimento 90-15 (Garuva).</span>
                                    </span>
                                </span>
                            </th>
                            <th>
                                <span class="th-content">Total
                                    <span class="tooltip-container info-tooltip" tabindex="0" aria-label="Total de estoque">
                                        <span class="info-tooltip-icon" aria-hidden="true">?</span>
                                        <span class="tooltip-bubble">Somat√≥rio dos estoques considerados para o produto.</span>
                                    </span>
                                </span>
                            </th>
                            <th>
                                <span class="th-content">Vendas 4M
                                    <span class="tooltip-container info-tooltip" tabindex="0" aria-label="Vendas acumuladas">
                                        <span class="info-tooltip-icon" aria-hidden="true">?</span>
                                        <span class="tooltip-bubble">Quantidade vendida nos √∫ltimos quatro meses.</span>
                                    </span>
                                </span>
                            </th>
                            <th>
                                <span class="th-content">M√©dia 3M
                                    <span class="tooltip-container info-tooltip" tabindex="0" aria-label="M√©dia de vendas">
                                        <span class="info-tooltip-icon" aria-hidden="true">?</span>
                                        <span class="tooltip-bubble">M√©dia mensal de vendas calculada para os √∫ltimos tr√™s meses.</span>
                                    </span>
                                </span>
                            </th>
                            <th>
                                <span class="th-content">Meses
                                    <span class="tooltip-container info-tooltip" tabindex="0" aria-label="Cobertura em meses">
                                        <span class="info-tooltip-icon" aria-hidden="true">?</span>
                                        <span class="tooltip-bubble">Cobertura aproximada de estoque com base na demanda recente.</span>
                                    </span>
                                </span>
                            </th>
                            <th>
                                <span class="th-content">Previs√£o
                                    <span class="tooltip-container info-tooltip" tabindex="0" aria-label="Como ler a previs√£o?">
                                        <span class="info-tooltip-icon" aria-hidden="true">?</span>
                                        <span class="tooltip-bubble">Resumo da proje√ß√£o de ruptura considerando consumo m√©dio e estoque dispon√≠vel.</span>
                                    </span>
                                </span>
                            </th>
                            <th>
                                <span class="th-content">Status
                                    <span class="tooltip-container info-tooltip" tabindex="0" aria-label="O que indica o status?">
                                        <span class="info-tooltip-icon" aria-hidden="true">?</span>
                                        <span class="tooltip-bubble">Classifica√ß√£o de risco baseada na cobertura (Cr√≠tico, Aten√ß√£o ou Bom).</span>
                                    </span>
                                </span>
                            </th>
                            <th>
                                <span class="th-content">Classe ABC
                                    <span class="tooltip-container info-tooltip" tabindex="0" aria-label="O que √© a classe ABC?">
                                        <span class="info-tooltip-icon" aria-hidden="true">?</span>
                                        <span class="tooltip-bubble">Faixa de prioridade definida pela participa√ß√£o do item nas vendas.</span>
                                    </span>
                                </span>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="productsTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal de Exporta√ß√£o -->
    <div id="exportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Exportar Dados</h2>
                <span class="close" onclick="closeExportModal()">&times;</span>
            </div>
            <div class="form-group">
                <label for="fileName">Nome do arquivo:</label>
                <input type="text" id="fileName" value="estoque_dados" placeholder="Digite o nome do arquivo">
            </div>
            <div class="form-group">
                <label for="fileFormat">Formato:</label>
                <select id="fileFormat">
                    <option value="xlsx">Excel (.xlsx)</option>
                    <option value="csv">CSV (.csv)</option>
                </select>
            </div>
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="closeExportModal()">Cancelar</button>
                <button onclick="confirmExport()">Exportar</button>
            </div>
        </div>
    </div>

    <!-- Inclus√£o das bibliotecas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="config.js"></script>
    
    <script>
        // Vari√°veis globais
        let allProductsData = [];
        let filteredData = [];
        let currentFilter = 'all';
        let currentEstablishment = '';
        let searchTerm = '';
        let predictionFilter = null;
        let selectedFamily = null;
        let selectedSupplier = null;
        let fileSystemSupported = false;
        let directoryHandle = null;
        let criticalFilterActive = false;
        let debugMode = false;
        let mappingDebugMode = false;
        let lastMappingInfo = null;
        let advancedStockFilter = '';
        let abcClassificationMap = new Map();

        // Fun√ß√£o de log para debug
        function debugLog(message, type) {
            type = type || 'info';
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            
            console.log(logMessage);
            
            if (debugMode) {
                const debugDiv = document.getElementById('debugInfo');
                if (debugDiv) {
                    debugDiv.innerHTML += logMessage + '<br>';
                    debugDiv.scrollTop = debugDiv.scrollHeight;
                }
            }
        }

        function toggleDebug() {
            debugMode = !debugMode;
            const debugDiv = document.getElementById('debugInfo');
            if (debugDiv) {
                debugDiv.style.display = debugMode ? 'block' : 'none';
                if (debugMode) {
                    debugDiv.innerHTML = '<strong>üêõ DEBUG MODE ATIVADO</strong><br>';
                    debugLog('Debug mode ativado');
                }
            }
        }

        function toggleMappingDebug() {
            mappingDebugMode = !mappingDebugMode;
            const mappingDiv = document.getElementById('mappingDebug');
            if (mappingDiv) {
                mappingDiv.style.display = mappingDebugMode ? 'block' : 'none';
                if (mappingDebugMode && lastMappingInfo) {
                    showMappingInfo(lastMappingInfo);
                }
            }
        }

        function showMappingInfo(mappingInfo) {
            const mappingDiv = document.getElementById('mappingDebug');
            if (!mappingDiv || !mappingDebugMode) return;

            let html = '<strong>üìã INFORMA√á√ïES DE MAPEAMENTO DE COLUNAS</strong><br><br>';
            html += `<strong>Colunas encontradas na planilha:</strong><br>`;
            mappingInfo.headers.forEach((header, index) => {
                html += `[${index}] "${header}"<br>`;
            });

            html += '<br><strong>Mapeamento aplicado:</strong><br>';
            for (const [field, index] of Object.entries(mappingInfo.mapping)) {
                const header = mappingInfo.headers[index] || '√çNDICE INV√ÅLIDO';
                const status = mappingInfo.headers[index] ? '‚úÖ' : '‚ùå';
                html += `${field} ‚Üí [${index}] "${header}" ${status}<br>`;
            }

            if (mappingInfo.warnings.length > 0) {
                html += '<br><strong>‚ö†Ô∏è Avisos:</strong><br>';
                mappingInfo.warnings.forEach(warning => {
                    html += `${warning}<br>`;
                });
            }

            mappingDiv.innerHTML = html;
        }

        function getConfigValue(path, fallback) {
            if (typeof getConfig === 'function') {
                const value = getConfig(path);
                if (typeof value !== 'undefined') {
                    return value;
                }
            } else if (window.dashboardConfig) {
                const keys = path.split('.');
                let current = window.dashboardConfig;
                for (const key of keys) {
                    if (current && typeof current === 'object' && key in current) {
                        current = current[key];
                    } else {
                        current = undefined;
                        break;
                    }
                }
                if (typeof current !== 'undefined') {
                    return current;
                }
            }

            return fallback;
        }

        function getPredictionSettings() {
            const defaults = { urgentDays: 30, warningDays: 60 };
            const configValues = getConfigValue('predictions', {}) || {};
            return Object.assign({}, defaults, {
                urgentDays: typeof configValues.urgentDays === 'number' ? configValues.urgentDays : defaults.urgentDays,
                warningDays: typeof configValues.warningDays === 'number' ? configValues.warningDays : defaults.warningDays
            });
        }

        function getReorderPointValue() {
            const reorder = getConfigValue('stockLevels.reorderPoint', null);
            return typeof reorder === 'number' ? reorder : null;
        }

        function calculateDailyDemand(product) {
            const media3M = toFiniteNumber(product.media3M);
            const vendas4M = toFiniteNumber(product.vendas4M);

            let monthlyAverage = 0;

            if (media3M !== null && media3M > 0) {
                monthlyAverage = media3M;
            } else if (vendas4M !== null && vendas4M > 0) {
                monthlyAverage = vendas4M / 4;
            }

            if (monthlyAverage > 0) {
                return monthlyAverage / 30;
            }

            const stockMonths = toFiniteNumber(product.stockMonths);

            if (stockMonths !== null && stockMonths > 0) {
                const totalStock = ['stock14', 'stock9013', 'stock9015'].reduce(function(sum, key) {
                    const value = toFiniteNumber(product[key]);
                    return sum + (value === null ? 0 : value);
                }, 0);

                if (totalStock > 0) {
                    const inferredDaily = totalStock / (stockMonths * 30);
                    return Number.isFinite(inferredDaily) && inferredDaily > 0 ? inferredDaily : 0;
                }
            }

            return 0;
        }

        function getCoverageInfo(product) {
            const stockAvailable = getProductStock(product);
            const dailyDemand = calculateDailyDemand(product);

            if (stockAvailable <= 0) {
                return {
                    stockAvailable,
                    dailyDemand,
                    daysToDepletion: 0,
                    hasDemand: dailyDemand > 0,
                    outOfStock: true
                };
            }

            if (dailyDemand <= 0) {
                return {
                    stockAvailable,
                    dailyDemand,
                    daysToDepletion: null,
                    hasDemand: false,
                    outOfStock: false
                };
            }

            return {
                stockAvailable,
                dailyDemand,
                daysToDepletion: stockAvailable / dailyDemand,
                hasDemand: true,
                outOfStock: false
            };
        }

        function formatStatValue(value, digits = 1) {
            if (value === null || typeof value === 'undefined' || Number.isNaN(value)) {
                return '--';
            }

            return value.toFixed(digits);
        }

        function toFiniteNumber(value) {
            if (value === null || typeof value === 'undefined') {
                return null;
            }

            const numeric = Number(value);
            return Number.isFinite(numeric) ? numeric : null;
        }

        function formatIntegerValue(value) {
            return typeof value === 'number' && Number.isFinite(value)
                ? value.toLocaleString()
                : '--';
        }

        function escapeHtml(value) {
            if (value === null || typeof value === 'undefined') {
                return '';
            }

            return String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function applyPredictionLabels() {
            const { urgentDays, warningDays } = getPredictionSettings();
            const urgentLabel = document.getElementById('urgentDaysLabel');
            const warningLabel = document.getElementById('warningDaysLabel');
            const reorderElement = document.getElementById('reorderPoint');
            const reorderPointValue = getReorderPointValue();

            if (urgentLabel) {
                urgentLabel.textContent = urgentDays;
            }

            if (warningLabel) {
                warningLabel.textContent = warningDays;
            }

            if (reorderElement) {
                reorderElement.textContent = typeof reorderPointValue === 'number'
                    ? `${reorderPointValue} meses`
                    : '--';
            }
        }

        // Detectar suporte ao File System Access API
        function detectBrowserCapabilities() {
            debugLog('Iniciando detec√ß√£o de capacidades do navegador');
            
            try {
                const isFileProtocol = location.protocol === 'file:';
                const isHttps = location.protocol === 'https:';
                const isLocalhost = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
                
                debugLog(`Protocolo atual: ${location.protocol}`);
                debugLog(`√â file://: ${isFileProtocol}`);
                debugLog(`√â HTTPS: ${isHttps}`);
                debugLog(`√â localhost: ${isLocalhost}`);
                
                const hasAPI = 'showDirectoryPicker' in window;
                debugLog(`showDirectoryPicker dispon√≠vel: ${hasAPI}`);
                
                const userAgent = navigator.userAgent;
                const isChrome = userAgent.includes('Chrome') && !userAgent.includes('Edg');
                const isEdge = userAgent.includes('Edg');
                debugLog(`Navegador detectado - Chrome: ${isChrome}, Edge: ${isEdge}`);
                
                const isSecureContext = !isFileProtocol && (isHttps || isLocalhost);
                fileSystemSupported = hasAPI && isSecureContext && (isChrome || isEdge);
                debugLog(`File System API suportado: ${fileSystemSupported}`);
                
                const indicator = document.getElementById('browserModeIndicator');
                
                if (!indicator) {
                    debugLog('Elemento browserModeIndicator n√£o encontrado', 'warn');
                    return;
                }
                
                if (isFileProtocol) {
                    indicator.innerHTML = `
                        <div style="text-align: left;">
                            üîç <strong>Modo Arquivo Local</strong> - Salvamento autom√°tico n√£o dispon√≠vel<br>
                            üí° <strong>Para ativar salvamento autom√°tico:</strong><br>
                            ‚Ä¢ Use um servidor web local (Live Server, http-server, etc.)<br>
                            ‚Ä¢ Ou acesse via https://seu-site.com<br>
                            ‚Ä¢ Use o bot√£o "üíæ Baixar data.js" para salvar manualmente
                        </div>
                    `;
                    indicator.style.background = '#e7f3ff';
                    indicator.style.color = '#0066cc';
                    indicator.style.padding = '12px';
                    indicator.style.borderLeft = '4px solid #0066cc';
                    debugLog('Modo file:// detectado - salvamento autom√°tico desabilitado');
                    
                } else if (fileSystemSupported) {
                    indicator.innerHTML = '‚ú® Salvamento autom√°tico dispon√≠vel! (Chrome/Edge + Servidor Web)';
                    indicator.style.background = '#d4edda';
                    indicator.style.color = '#155724';
                    
                    setTimeout(function() {
                        const autoSaveBtn = document.getElementById('autoSaveBtn');
                        const testBtn = document.getElementById('testBtn');
                        
                        if (autoSaveBtn) {
                            autoSaveBtn.style.display = 'inline-block';
                            autoSaveBtn.classList.add('ready');
                            debugLog('Bot√£o autoSave mostrado');
                        }
                        
                        if (testBtn) {
                            testBtn.style.display = 'inline-block';
                        }
                    }, 300);
                } else {
                    let reason = '';
                    let solution = '';
                    
                    if (!hasAPI) {
                        reason = 'API n√£o suportada neste navegador';
                        solution = 'Use Chrome ou Edge atualizado';
                    } else if (!isSecureContext) {
                        reason = 'Requer conex√£o segura (HTTPS ou localhost)';
                        solution = 'Use um servidor web local ou HTTPS';
                    } else if (!isChrome && !isEdge) {
                        reason = 'Navegador n√£o suportado';
                        solution = 'Use Chrome ou Edge';
                    }
                    
                    indicator.innerHTML = `
                        <div style="text-align: left;">
                            ‚ö†Ô∏è <strong>Salvamento autom√°tico n√£o dispon√≠vel</strong><br>
                            üîç <strong>Motivo:</strong> ${reason}<br>
                            üí° <strong>Solu√ß√£o:</strong> ${solution}<br>
                            üî• Use o bot√£o "üíæ Baixar data.js" para salvar manualmente
                        </div>
                    `;
                    indicator.style.background = '#fff3cd';
                    indicator.style.color = '#856404';
                    indicator.style.padding = '12px';
                    indicator.style.borderLeft = '4px solid #ffc107';
                    debugLog(`Salvamento autom√°tico n√£o dispon√≠vel: ${reason}`);
                }
            } catch (error) {
                debugLog(`Erro na detec√ß√£o de capacidades: ${error.message}`, 'error');
                fileSystemSupported = false;
            }
        }

        // Fun√ß√£o principal para configurar pasta
        function tryAutoSave() {
            debugLog('=== TENTATIVA DE CONFIGURA√á√ÉO DE PASTA ===');
            
            if (location.protocol === 'file:') {
                const msg = `
                    ‚ö†Ô∏è Salvamento autom√°tico n√£o funciona com arquivos locais (file://)
                    
                    üí° Para ativar esta funcionalidade:
                    ‚Ä¢ Use um servidor web local (Live Server, Python, etc.)
                    ‚Ä¢ Acesse via http://localhost ou https://
                    
                    üî• Por enquanto, use "üíæ Baixar data.js" para salvar manualmente
                `;
                showMessage(msg, 'warning');
                debugLog('Tentativa de uso em protocolo file:// - n√£o suportado', 'warn');
                
                const downloadBtn = document.querySelector('button[onclick="downloadDataFile()"]');
                if (downloadBtn) {
                    downloadBtn.style.animation = 'pulse 2s infinite';
                    setTimeout(() => {
                        downloadBtn.style.animation = '';
                    }, 5000);
                }
                return;
            }
            
            if (!fileSystemSupported) {
                const msg = '‚ùå Salvamento autom√°tico n√£o suportado neste navegador/ambiente.';
                showMessage(msg, 'error');
                debugLog(msg, 'error');
                return;
            }

            if (allProductsData.length === 0) {
                const msg = '‚ö†Ô∏è Nenhum dado para salvar. Importe uma planilha primeiro.';
                showMessage(msg, 'warning');
                debugLog(msg, 'warn');
                return;
            }

            debugLog('Solicitando sele√ß√£o de pasta ao usu√°rio');
            
            window.showDirectoryPicker({
                mode: 'readwrite',
                startIn: 'documents'
            }).then(function(handle) {
                debugLog('Pasta selecionada com sucesso');
                directoryHandle = handle;
                
                showMessage('‚úÖ Pasta configurada! Salvando arquivo...', 'success');
                updateUI();
                
                return saveDataAutomatically();
                
            }).then(function(success) {
                if (success) {
                    showMessage('‚ú® Arquivo data.js salvo automaticamente na pasta selecionada!', 'success');
                    debugLog('Salvamento autom√°tico conclu√≠do com sucesso');
                } else {
                    showMessage('‚ùå Erro ao salvar o arquivo. Verifique as permiss√µes.', 'error');
                    debugLog('Falha no salvamento autom√°tico', 'error');
                }
            }).catch(function(error) {
                if (error.name === 'AbortError') {
                    debugLog('Usu√°rio cancelou a sele√ß√£o de pasta');
                    showMessage('‚ùå Sele√ß√£o de pasta cancelada pelo usu√°rio.', 'info');
                } else {
                    debugLog(`Erro no processo: ${error.message}`, 'error');
                    showMessage(`‚ùå Erro: ${error.message}`, 'error');
                }
            });
        }

        function reconfigureAutoSave() {
            debugLog('Reconfigurando pasta para salvamento autom√°tico');
            directoryHandle = null;
            tryAutoSave();
        }

        function saveDataAutomatically() {
            return new Promise(function(resolve, reject) {
                debugLog('=== INICIANDO SALVAMENTO AUTOM√ÅTICO ===');
                
                if (!directoryHandle) {
                    debugLog('directoryHandle n√£o configurado', 'error');
                    resolve(false);
                    return;
                }
                
                if (allProductsData.length === 0) {
                    debugLog('Nenhum dado para salvar', 'error');
                    resolve(false);
                    return;
                }

                try {
                    debugLog('Gerando conte√∫do do arquivo data.js');
                    const dataContent = saveDataToFile(allProductsData);
                    debugLog(`Conte√∫do gerado: ${dataContent.length} caracteres`);
                    
                    debugLog('Verificando permiss√µes de escrita');
                    directoryHandle.requestPermission({ mode: 'readwrite' }).then(function(permission) {
                        debugLog(`Permiss√£o obtida: ${permission}`);
                        
                        if (permission !== 'granted') {
                            throw new Error('Permiss√£o de escrita negada');
                        }
                        
                        debugLog('Criando/obtendo arquivo data.js');
                        return directoryHandle.getFileHandle('data.js', { create: true });
                        
                    }).then(function(fileHandle) {
                        debugLog('Arquivo obtido, criando stream de escrita');
                        return fileHandle.createWritable();
                        
                    }).then(function(writable) {
                        debugLog('Escrevendo conte√∫do no arquivo');
                        return writable.write(dataContent).then(function() {
                            debugLog('Fechando arquivo');
                            return writable.close();
                        });
                        
                    }).then(function() {
                        debugLog('Arquivo salvo com sucesso!');
                        
                        localStorage.setItem('stockDataTimestamp', Date.now().toString());
                        updateUI();
                        
                        resolve(true);
                        
                    }).catch(function(error) {
                        debugLog(`Erro no salvamento: ${error.message}`, 'error');
                        reject(error);
                    });
                    
                } catch (error) {
                    debugLog(`Erro na gera√ß√£o do conte√∫do: ${error.message}`, 'error');
                    reject(error);
                }
            });
        }

        function testAutoSave() {
            debugLog('=== TESTE DE SALVAMENTO ===');
            
            if (!fileSystemSupported) {
                showMessage('‚ùå Salvamento autom√°tico n√£o suportado neste navegador.', 'error');
                return;
            }
            
            if (!directoryHandle) {
                showMessage('‚ö†Ô∏è Configure uma pasta primeiro clicando em "‚ú® Configurar Pasta".', 'warning');
                return;
            }
            
            if (allProductsData.length === 0) {
                showMessage('‚ö†Ô∏è Nenhum dado para testar. Importe uma planilha primeiro.', 'warning');
                return;
            }
            
            saveDataAutomatically().then(function(success) {
                if (success) {
                    showMessage('‚úÖ Teste realizado! Arquivo salvo com sucesso.', 'success');
                } else {
                    showMessage('‚ùå Falha no teste de salvamento.', 'error');
                }
            }).catch(function(error) {
                showMessage(`‚ùå Erro no teste: ${error.message}`, 'error');
            });
        }

        function updateUI() {
            debugLog('Atualizando interface do usu√°rio');
            
            try {
                const lastUpdateDiv = document.getElementById('lastUpdateInfo');
                if (!lastUpdateDiv) {
                    debugLog('Elemento lastUpdateInfo n√£o encontrado', 'warn');
                    return;
                }
                
                let infoText = '';
                
                if (typeof window.stockMetadata !== 'undefined' && window.stockMetadata.lastUpdate) {
                    const date = new Date(window.stockMetadata.lastUpdate);
                    const formattedDate = date.toLocaleString('pt-BR');
                    infoText = `üìÖ √öltima atualiza√ß√£o: ${formattedDate}`;
                } else {
                    const storedData = localStorage.getItem('stockDataTimestamp');
                    if (storedData) {
                        const date = new Date(parseInt(storedData));
                        const formattedDate = date.toLocaleString('pt-BR');
                        infoText = `üìÖ √öltima atualiza√ß√£o: ${formattedDate}`;
                    } else {
                        infoText = 'üìÖ Nenhuma importa√ß√£o realizada ainda';
                    }
                }
                
                if (fileSystemSupported && directoryHandle) {
                    const autoSaveBtn = document.getElementById('autoSaveBtn');
                    const reconfigBtn = document.getElementById('reconfigBtn');
                    const testBtn = document.getElementById('testBtn');
                    
                    if (autoSaveBtn) {
                        autoSaveBtn.textContent = '‚ú® Salvar na Pasta';
                        autoSaveBtn.classList.remove('ready');
                    }
                    if (reconfigBtn) reconfigBtn.style.display = 'inline-block';
                    if (testBtn) testBtn.style.display = 'inline-block';
                    
                    infoText += '<br>üóÇÔ∏è <span style="color: #28a745; font-weight: bold;">Pasta configurada - salvamento autom√°tico ativo!</span>';
                } else if (fileSystemSupported) {
                    infoText += '<br>‚öôÔ∏è <span style="color: #1F448C;">Clique em "‚ú® Configurar Pasta" para ativar salvamento autom√°tico</span>';
                }
                
                lastUpdateDiv.innerHTML = infoText;
                debugLog('Interface atualizada com sucesso');
                
            } catch (error) {
                debugLog(`Erro ao atualizar interface: ${error.message}`, 'error');
            }
        }

        // Carregar dados ao inicializar
        function loadData() {
            debugLog('=== CARREGANDO DADOS ===');
            
            if (typeof window.stockData !== 'undefined' && Array.isArray(window.stockData) && window.stockData.length > 0) {
                allProductsData = window.stockData;
                debugLog(`Dados carregados do data.js: ${allProductsData.length} produtos`);
                showMessage(`‚úÖ ${allProductsData.length} produtos carregados do data.js`, 'success');
            } else {
                const storedData = localStorage.getItem('stockData');
                if (storedData) {
                    try {
                        allProductsData = JSON.parse(storedData);
                        debugLog(`Dados carregados do localStorage: ${allProductsData.length} produtos`);
                        showMessage(`‚úÖ ${allProductsData.length} produtos carregados do backup local`, 'info');
                    } catch (e) {
                        debugLog(`Erro ao parsear dados do localStorage: ${e.message}`, 'error');
                        allProductsData = [];
                    }
                } else {
                    allProductsData = [];
                    debugLog('Nenhum dado encontrado');
                }
            }

            if (allProductsData.length === 0) {
                showMessage('‚ö†Ô∏è Nenhum dado encontrado. Importe uma planilha para come√ßar.', 'info');
            }

            initializeDashboard();
        }

        function initializeDashboard() {
            debugLog('Inicializando dashboard');
            
            try {
                populateFamilyFilter();
                populateSupplierFilter();
                showAllProducts();
                updatePredictiveAnalysis();
                updateUI();
                
                debugLog('Dashboard inicializado com sucesso');
            } catch (error) {
                debugLog(`Erro ao inicializar dashboard: ${error.message}`, 'error');
                showMessage('‚ö†Ô∏è Dashboard carregado com problemas. Use o diagn√≥stico para mais detalhes.', 'warning');
            }
        }

        function saveDataToFile(data) {
            try {
                debugLog('Gerando arquivo data.js');
                
                const processedData = data.map(function(product) {
                    return {
                        code: product.code || '',
                        supplier: product.supplier || '',
                        family: product.family || '',
                        item: product.item || '',
                        stock14: product.stock14 || 0,
                        stock9013: product.stock9013 || 0,
                        stock9015: product.stock9015 || 0,
                        stockMonths: product.stockMonths || 0,
                        vendas4M: product.vendas4M || 0,
                        media3M: product.media3M || 0
                    };
                });

                const dataContent = `// Dados do Dashboard de Estoque v1.2 - Gerado em ${new Date().toLocaleString('pt-BR')}
// Substitua este arquivo na pasta compartilhada para atualizar os dados
console.log('Carregando data.js v1.2...');

window.stockData = ${JSON.stringify(processedData, null, 2)};

// Metadados
window.stockMetadata = {
    lastUpdate: "${new Date().toISOString()}",
    totalProducts: ${processedData.length},
    generatedBy: "Dashboard de Estoque v1.2 - Mapeamento Corrigido",
    version: "1.2.0"
};

console.log('data.js v1.2 carregado com', window.stockData.length, 'produtos');`;
                
                debugLog(`Arquivo gerado: ${dataContent.length} caracteres`);
                return dataContent;
            } catch (error) {
                debugLog(`Erro ao gerar arquivo: ${error.message}`, 'error');
                throw error;
            }
        }

        function importData() {
            const file = document.getElementById('excelFile').files[0];
            if (!file) {
                showMessage('‚ùå Por favor, selecione um arquivo primeiro.', 'error');
                return;
            }

            debugLog(`Importando arquivo: ${file.name} (${file.size} bytes)`);

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    let data;
                    const fileName = file.name.toLowerCase();
                    
                    if (fileName.endsWith('.csv')) {
                        data = processCSV(e.target.result);
                    } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                        const workbook = XLSX.read(e.target.result, {type: 'array'});
                        const sheetName = workbook.SheetNames[0];
                        const sheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(sheet);
                        data = processExcelData(jsonData);
                    } else {
                        throw new Error('Formato de arquivo n√£o suportado');
                    }

                    if (data.length === 0) {
                        throw new Error('Nenhum produto v√°lido encontrado na planilha');
                    }

                    allProductsData = data;
                    debugLog(`Dados importados: ${data.length} produtos`);
                    
                    localStorage.setItem('stockData', JSON.stringify(data));
                    localStorage.setItem('stockDataTimestamp', Date.now().toString());
                    
                    showMessage(`‚úÖ Dados importados com sucesso! ${data.length} produtos carregados.`, 'success');
                    
                    if (fileSystemSupported && directoryHandle) {
                        debugLog('Tentando salvamento autom√°tico ap√≥s importa√ß√£o');
                        saveDataAutomatically().then(function(success) {
                            if (success) {
                                showMessage('‚ú® Arquivo data.js atualizado automaticamente!', 'success');
                            }
                        }).catch(function(error) {
                            debugLog(`Erro no salvamento autom√°tico: ${error.message}`, 'error');
                            showMessage('‚ö†Ô∏è Dados importados, mas erro no salvamento autom√°tico. Use "üíæ Baixar data.js".', 'warning');
                        });
                    } else if (fileSystemSupported) {
                        showMessage('üí° Dica: Clique em "‚ú® Configurar Pasta" para ativar salvamento autom√°tico!', 'info');
                    }
                    
                    initializeDashboard();
                    
                } catch (error) {
                    debugLog(`Erro ao processar arquivo: ${error.message}`, 'error');
                    showMessage(`‚ùå Erro ao processar arquivo: ${error.message}`, 'error');
                }
            };

            if (file.name.toLowerCase().endsWith('.csv')) {
                reader.readAsText(file);
            } else {
                reader.readAsArrayBuffer(file);
            }
        }

        function openTemplateGenerator() {
            try {
                window.open('gerador_template.html', '_blank');
            } catch (error) {
                debugLog(`Erro ao abrir gerador de template: ${error.message}`, 'error');
                showMessage('‚ùå Erro ao abrir gerador de template', 'error');
            }
        }

        function runDiagnostic() {
            debugLog('=== EXECUTANDO DIAGN√ìSTICO COMPLETO ===');
            console.clear();
            
            const report = [];
            report.push('üîç DIAGN√ìSTICO COMPLETO DO DASHBOARD v1.2');
            report.push('==========================================');
            
            // 1. Verificar dados
            report.push('\nüìä DADOS:');
            report.push(`- window.stockData existe: ${typeof window.stockData !== 'undefined'}`);
            report.push(`- √â array: ${Array.isArray(window.stockData)}`);
            report.push(`- Quantidade: ${window.stockData ? window.stockData.length : 0}`);
            report.push(`- allProductsData: ${allProductsData ? allProductsData.length : 'undefined'}`);
            
            // 2. Verificar elementos DOM
            report.push('\nüéØ ELEMENTOS DOM:');
            const elementos = ['importContent', 'toggleIcon', 'browserModeIndicator', 'autoSaveBtn', 'testBtn', 'lastUpdateInfo', 'excelFile', 'mappingDebug'];
            elementos.forEach(function(id) {
                const el = document.getElementById(id);
                const exists = !!el;
                const visible = el ? el.offsetHeight > 0 : false;
                report.push(`- ${id}: ${exists ? '‚úÖ' : '‚ùå'} ${exists ? (visible ? '(vis√≠vel)' : '(oculto)') : ''}`);
            });
            
            // 3. Verificar capacidades do navegador
            report.push('\nüåê NAVEGADOR:');
            report.push(`- UserAgent: ${navigator.userAgent}`);
            report.push(`- Protocolo: ${location.protocol}`);
            report.push(`- Hostname: ${location.hostname}`);
            report.push(`- URL completa: ${location.href}`);
            report.push(`- showDirectoryPicker: ${'showDirectoryPicker' in window ? '‚úÖ' : '‚ùå'}`);
            report.push(`- fileSystemSupported: ${fileSystemSupported ? '‚úÖ' : '‚ùå'}`);
            report.push(`- directoryHandle: ${directoryHandle ? '‚úÖ Configurado' : '‚ùå N√£o configurado'}`);
            
            // 4. Verificar localStorage
            report.push('\nüíæ ARMAZENAMENTO LOCAL:');
            const storedData = localStorage.getItem('stockData');
            const storedTimestamp = localStorage.getItem('stockDataTimestamp');
            report.push(`- Dados salvos: ${storedData ? 'Sim' : 'N√£o'}`);
            report.push(`- Timestamp: ${storedTimestamp ? new Date(parseInt(storedTimestamp)).toLocaleString('pt-BR') : 'N√£o'}`);
            
            // 5. Verificar mapeamento (novo)
            report.push('\nüìã MAPEAMENTO:');
            if (lastMappingInfo) {
                report.push('- √öltimo mapeamento executado: ‚úÖ');
                report.push(`- Colunas detectadas: ${lastMappingInfo.headers.length}`);
                report.push(`- Avisos de mapeamento: ${lastMappingInfo.warnings.length}`);
                if (lastMappingInfo.warnings.length > 0) {
                    lastMappingInfo.warnings.forEach(warning => {
                        report.push(`  ‚ö†Ô∏è ${warning}`);
                    });
                }
            } else {
                report.push('- Nenhum mapeamento executado ainda');
            }
            
            // 6. Verificar funcionalidades
            report.push('\n‚öôÔ∏è FUNCIONALIDADES:');
            report.push(`- Import section expanded: ${document.getElementById('importContent')?.classList.contains('expanded') ? 'Sim' : 'N√£o'}`);
            report.push(`- Debug mode: ${debugMode ? 'Ativo' : 'Inativo'}`);
            report.push(`- Mapping debug mode: ${mappingDebugMode ? 'Ativo' : 'Inativo'}`);
            
            if (location.protocol === 'file:') {
                report.push('\nüöÄ INSTRU√á√ïES PARA SALVAMENTO AUTOM√ÅTICO:');
                report.push('Voc√™ est√° usando protocolo file://, que n√£o suporta File System API.');
                report.push('Para ativar salvamento autom√°tico, use um servidor web local:');
                report.push('');
                report.push('M√âTODO 1 - Python (j√° instalado no Windows):');
                report.push('1. Abra o Prompt de Comando na pasta do projeto');
                report.push('2. Execute: python -m http.server 8000');
                report.push('3. Acesse: http://localhost:8000');
                report.push('');
                report.push('M√âTODO 2 - Live Server (VS Code):');
                report.push('1. Instale a extens√£o "Live Server" no VS Code');
                report.push('2. Clique direito no index.html ‚Üí "Open with Live Server"');
                report.push('3. Acesse: http://localhost:5500');
            }
            
            report.push('\nüéØ DIAGN√ìSTICO CONCLU√çDO!');
            
            // Mostrar relat√≥rio
            const fullReport = report.join('\n');
            console.log(fullReport);
            
            if (debugMode) {
                const debugDiv = document.getElementById('debugInfo');
                if (debugDiv) {
                    debugDiv.innerHTML = '<pre>' + fullReport + '</pre>';
                }
            }
            
            showMessage('üîç Diagn√≥stico executado! Verifique o console (F12) para detalhes completos.', 'info');
        }

        function toggleImportSection() {
            const content = document.getElementById('importContent');
            const icon = document.getElementById('toggleIcon');
            
            if (!content || !icon) {
                debugLog('Elementos de importa√ß√£o n√£o encontrados', 'error');
                return;
            }
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                icon.classList.remove('expanded');
                icon.textContent = '‚ñº';
                debugLog('Se√ß√£o de importa√ß√£o fechada');
            } else {
                content.classList.add('expanded');
                icon.classList.add('expanded');  
                icon.textContent = '‚ñ≤';
                debugLog('Se√ß√£o de importa√ß√£o aberta');
            }
        }

        function downloadDataFile() {
            if (allProductsData.length === 0) {
                showMessage('‚ùå Nenhum dado para salvar. Importe uma planilha primeiro.', 'error');
                return;
            }

            const dataContent = saveDataToFile(allProductsData);
            const blob = new Blob([dataContent], { type: 'text/javascript' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'data.js';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showMessage('üíæ Arquivo data.js baixado! Substitua o arquivo na pasta compartilhada.', 'success');
            debugLog('Arquivo data.js baixado via download manual');
        }

        function showMessage(message, type) {
            const messagesDiv = document.getElementById('importMessages');
            const messageClass = {
                'success': 'success-message',
                'error': 'error-message',
                'warning': 'warning-message',
                'info': 'info-message'
            }[type] || 'info-message';
            
            messagesDiv.innerHTML = `<div class="${messageClass}">${message}</div>`;
            
            setTimeout(function() {
                messagesDiv.innerHTML = '';
            }, 8000);
        }

        // === FUN√á√ïES DE BUSCA E FILTROS ===
        function performGlobalSearch() {
            const searchInput = document.getElementById('globalSearch');
            searchTerm = searchInput.value.toLowerCase().trim();
            
            if (searchTerm === '') {
                document.getElementById('searchResults').innerHTML = '';
                applyAllFilters();
                removeHighlights();
                return;
            }

            resetAllFilters();

            const searchResults = allProductsData.filter(function(product) {
                return product.code.toLowerCase().includes(searchTerm) ||
                    product.item.toLowerCase().includes(searchTerm) ||
                    product.supplier.toLowerCase().includes(searchTerm) ||
                    product.family.toLowerCase().includes(searchTerm);
            });

            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = `üîç <strong>${searchResults.length}</strong> produtos encontrados para: "<em>${searchTerm}</em>"`;

            applyAllFilters();
            highlightSearchResults();
        }

        function resetAllFilters() {
            currentFilter = 'all';
            predictionFilter = null;
            selectedFamily = null;
            selectedSupplier = null;
            currentEstablishment = '';
            criticalFilterActive = false;
            advancedStockFilter = '';

            document.getElementById('familyFilter').value = '';
            document.getElementById('supplierFilter').value = '';
            document.getElementById('establishmentFilter').value = '';
            const advancedDropdown = document.getElementById('advancedStockFilter');
            if (advancedDropdown) {
                advancedDropdown.value = '';
            }

            updateActiveButton('all');

            const activeItems = document.querySelectorAll('.prediction-item.active');
            activeItems.forEach(function(item) {
                item.classList.remove('active');
            });
        }

        function clearSearch() {
            document.getElementById('globalSearch').value = '';
            document.getElementById('searchResults').innerHTML = '';
            searchTerm = '';
            applyAllFilters();
            removeHighlights();
        }

        function highlightSearchResults() {
            const gaugeCards = document.querySelectorAll('.gauge-card');
            gaugeCards.forEach(function(card) {
                const title = card.querySelector('.gauge-title').textContent.toLowerCase();
                if (searchTerm && title.includes(searchTerm)) {
                    card.classList.add('highlighted');
                } else {
                    card.classList.remove('highlighted');
                }
            });

            const tableRows = document.querySelectorAll('#productsTableBody tr');
            tableRows.forEach(function(row) {
                const rowText = row.textContent.toLowerCase();
                if (searchTerm && rowText.includes(searchTerm)) {
                    row.classList.add('highlighted');
                    row.classList.add('highlight-animation');
                } else {
                    row.classList.remove('highlighted');
                }
            });
        }

        function removeHighlights() {
            const highlighted = document.querySelectorAll('.highlighted');
            highlighted.forEach(function(el) {
                el.classList.remove('highlighted');
            });
            const animations = document.querySelectorAll('.highlight-animation');
            animations.forEach(function(el) {
                el.classList.remove('highlight-animation');
            });
        }

        // === FUN√á√ïES DE DADOS - VERS√ÉO CORRIGIDA ===
        function processCSV(csvText) {
            const lines = csvText.split('\n');
            if (lines.length < 2) return [];

            const headers = lines[0].split(',').map(function(h) {
                return h.trim().replace(/"/g, '');
            });
            const products = [];

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                const values = parseCSVLine(line);
                if (values.length < headers.length) continue;

                const product = mapProductData(headers, values);
                if (product.code) {
                    products.push(product);
                }
            }

            return products;
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim());
            return result;
        }

        function processExcelData(jsonData) {
            const products = [];
            
            for (const row of jsonData) {
                const product = mapProductData(Object.keys(row), Object.values(row));
                if (product.code) {
                    products.push(product);
                }
            }
            
            return products;
        }

        function mapProductData(headers, values) {
            const mapping = findColumnMapping(headers);
            
            return {
                code: sanitizeText(values[mapping.code] || ''),
                supplier: sanitizeText(values[mapping.supplier] || ''),
                family: sanitizeText(values[mapping.family] || ''),
                item: sanitizeText(values[mapping.item] || ''),
                stock14: parseNumber(values[mapping.stock14] || 0),
                stock9013: parseNumber(values[mapping.stock9013] || 0),
                stock9015: parseNumber(values[mapping.stock9015] || 0),
                stockMonths: parseNumber(values[mapping.stockMonths] || 0),
                vendas4M: parseNumber(values[mapping.vendas4M] || 0),
                media3M: parseNumber(values[mapping.media3M]) || 0

            };
        }

        // FUN√á√ÉO CORRIGIDA v1.2.2 - Mapeamento Espec√≠fico para sua Planilha
        function findColumnMapping(headers) {
            debugLog('=== MAPEAMENTO v1.2.2 - AN√ÅLISE ESPEC√çFICA ===');
            debugLog(`Colunas encontradas: ${headers.length}`);
            
            // Log todas as colunas encontradas
            headers.forEach((h, index) => {
                debugLog(`[${index}] "${h}"`);
            });
            
            const upperHeaders = headers.map(h => (h || '').toString().toUpperCase().trim());
            const mapping = {};
            const warnings = [];

            // MAPEAMENTO DIRETO E ESPEC√çFICO baseado na sua planilha
            
            // 1. C√ìDIGO (primeira coluna)
           // 7. VENDAS 3M - busca espec√≠fica para evitar conflito com VENDAS 3M
            for (let i = 0; i < upperHeaders.length; i++) {
                 const h = upperHeaders[i];
            if ((h.includes("VENDAS") && h.includes("4M")) || 
                    (h.includes("SALES") && h.includes("4M")) ||
                    (h === "VENDAS 4M") || (h === "VENDAS4M")) {
                    mapping.vendas4M = i;
                    debugLog(`vendas4M: ${i} - ${headers[i]}`);
                    break;
                }
            }

            // 8. M√âDIA 3M - novo mapeamento espec√≠fico
            for (let i = 0; i < upperHeaders.length; i++) {
                const h = upperHeaders[i];
                if (h === "M√âDIA 3M" || h === "MEDIA 3M" || h === "MEDIA3M" || h === "M√âDIA3M") {
                    mapping.media3M = i;
                    debugLog(`media3M: ${i} - ${headers[i]}`);
                    break;
                }
            }   

            
            // 2. FORNECEDOR
            for (let i = 0; i < upperHeaders.length; i++) {
                const h = upperHeaders[i];
                if (h === 'FORNECEDOR' || h === 'SUPPLIER') {
                    mapping.supplier = i;
                    debugLog(`‚úÖ supplier ‚Üí [${i}] "${headers[i]}"`);
                    break;
                }
            }
            
            // 3. FAM√çLIA
            for (let i = 0; i < upperHeaders.length; i++) {
                const h = upperHeaders[i];
                if (h === 'FAM√çLIA' || h === 'FAMILIA' || h === 'FAMILY') {
                    mapping.family = i;
                    debugLog(`‚úÖ family ‚Üí [${i}] "${headers[i]}"`);
                    break;
                }
            }
            
            // 4. ITEM
            for (let i = 0; i < upperHeaders.length; i++) {
                const h = upperHeaders[i];
                if (h === 'ITEM' || h === 'PRODUTO' || h === 'PRODUCT') {
                    mapping.item = i;
                    debugLog(`‚úÖ item ‚Üí [${i}] "${headers[i]}"`);
                    break;
                }
            }
            
            // 5. ESTABELECIMENTOS - Busca muito espec√≠fica
            for (let i = 0; i < upperHeaders.length; i++) {
                const h = upperHeaders[i];
                
                // 1-4 (GUARULHOS)
                if (h === '1-4' || h === '1_4') {
                    mapping.stock14 = i;
                    debugLog(`‚úÖ stock14 (1-4) ‚Üí [${i}] "${headers[i]}"`);
                }
                
                // 90-13 (ITAJA√ç)  
                else if (h === '90-13' || h === '90_13') {
                    mapping.stock9013 = i;
                    debugLog(`‚úÖ stock9013 (90-13) ‚Üí [${i}] "${headers[i]}"`);
                }
                
                // 90-15 (GARUVA) - BUSCA MUITO ESPEC√çFICA
                else if (h === '90-15' || h === '90_15') {
                    mapping.stock9015 = i;
                    debugLog(`‚úÖ stock9015 (90-15) ‚Üí [${i}] "${headers[i]}"`);
                }
            }
            
            // 6. ESTOQUE EM MESES
            for (let i = 0; i < upperHeaders.length; i++) {
                const h = upperHeaders[i];
                if (h.includes('MESES') || h.includes('ESTOQUE EM MESES') || h === 'STOCKMONTHS') {
                    mapping.stockMonths = i;
                    debugLog(`‚úÖ stockMonths ‚Üí [${i}] "${headers[i]}"`);
                    break;
                }
            }
            
            // 7. VENDAS 3M
            for (let i = 0; i < upperHeaders.length; i++) {
                const h = upperHeaders[i];
                if (h.includes('VENDAS') || h.includes('SALES')) {
                    mapping.vendas4M = i;
                    debugLog(`‚úÖ vendas4M ‚Üí [${i}] "${headers[i]}"`);
                    break;
                }
            }

            // VERIFICA√á√ÉO ESPECIAL PARA 90-15
            debugLog('=== VERIFICA√á√ÉO ESPECIAL PARA 90-15 ===');
            let found9015 = false;
            for (let i = 0; i < headers.length; i++) {
                const original = headers[i];
                const upper = upperHeaders[i];
                debugLog(`Verificando [${i}] "${original}" (upper: "${upper}")`);
                
                if (original === '90-15' || upper === '90-15' || original === '90_15' || upper === '90_15') {
                    mapping.stock9015 = i;
                    debugLog(`üéØ ENCONTRADO 90-15 ‚Üí [${i}] "${original}"`);
                    found9015 = true;
                    break;
                }
            }
            
            if (!found9015) {
                warnings.push('CR√çTICO: Coluna 90-15 N√ÉO ENCONTRADA!');
                debugLog('üö® CR√çTICO: Coluna 90-15 N√ÉO ENCONTRADA na planilha!');
            }

            // FALLBACK APENAS SE ABSOLUTAMENTE NECESS√ÅRIO
            const fallbacks = {
                code: 0, supplier: 1, family: 2, item: 3,
                stock14: 5, stock9013: 6, stock9015: 7, 
                stockMonths: 8, vendas4M: 9
            };

            for (const [field, fallbackIndex] of Object.entries(fallbacks)) {
                if (mapping[field] === undefined) {
                    if (fallbackIndex < headers.length) {
                        mapping[field] = fallbackIndex;
                        warnings.push(`${field} usando fallback [${fallbackIndex}] "${headers[fallbackIndex]}"`);
                        debugLog(`üîÑ ${field} ‚Üí [${fallbackIndex}] "${headers[fallbackIndex]}" (FALLBACK)`);
                    } else {
                        mapping[field] = 0;
                        warnings.push(`${field} usando √≠ndice 0 por seguran√ßa`);
                        debugLog(`‚ö° ${field} ‚Üí [0] (SEGURAN√áA)`);
                    }
                }
            }

            // RELAT√ìRIO FINAL
            debugLog('=== MAPEAMENTO FINAL v1.2.2 ===');
            for (const [field, index] of Object.entries(mapping)) {
                const header = headers[index] || 'INV√ÅLIDO';
                debugLog(`${field.padEnd(12)} ‚Üí [${index}] "${header}"`);
            }

            // VALIDA√á√ÉO CR√çTICA PARA 90-15
            if (mapping.stock9015 !== undefined) {
                const mappedHeader = headers[mapping.stock9015];
                if (mappedHeader !== '90-15' && mappedHeader !== '90_15') {
                    warnings.push(`ATEN√á√ÉO: stock9015 mapeado para "${mappedHeader}" em vez de "90-15"`);
                    debugLog(`‚ö†Ô∏è stock9015 mapeado para "${mappedHeader}" - pode estar incorreto`);
                }
            }

            // SALVAR INFO DE MAPEAMENTO PARA DEBUG
            lastMappingInfo = {
                headers: headers.slice(),
                mapping: Object.assign({}, mapping),
                warnings: warnings.slice(),
                version: '1.2.2'
            };

            debugLog(`=== MAPEAMENTO v1.2.2 CONCLU√çDO - ${warnings.length} avisos ===`);
            warnings.forEach(warning => debugLog(`‚ö†Ô∏è ${warning}`));

            // Mostrar info de mapeamento se debug estiver ativo
            if (mappingDebugMode) {
                showMappingInfo(lastMappingInfo);
            }

            return mapping;
        }

        function sanitizeText(text) {
            if (!text) return '';
            return text.toString().trim().replace(/"/g, '');
        }

        function parseNumber(value) {
            if (!value && value !== 0) return 0;
            
            const cleaned = value.toString().replace(/[^\d.,-]/g, '').replace(',', '.');
            const parsed = parseFloat(cleaned);
            
            return isNaN(parsed) ? 0 : parsed;
        }

        // === FUN√á√ïES DE FILTROS ===
        function populateFamilyFilter() {
            const families = [...new Set(allProductsData.map(function(p) {
                return p.family;
            }))].sort();
            const select = document.getElementById('familyFilter');
            select.innerHTML = '<option value="">Todas as Fam√≠lias</option>';
            families.forEach(function(family) {
                const option = document.createElement('option');
                option.value = family;
                option.textContent = family;
                select.appendChild(option);
            });
        }

        function populateSupplierFilter() {
            const suppliers = [...new Set(allProductsData.map(function(p) {
                return p.supplier;
            }))].sort();
            const select = document.getElementById('supplierFilter');
            select.innerHTML = '<option value="">Todos os Fornecedores</option>';
            suppliers.forEach(function(supplier) {
                const option = document.createElement('option');
                option.value = supplier;
                option.textContent = supplier;
                select.appendChild(option);
            });
        }

        function showAllProducts() {
            currentFilter = 'all';
            predictionFilter = null;
            selectedFamily = null;
            selectedSupplier = null;
            criticalFilterActive = false;
            const activeItems = document.querySelectorAll('.prediction-item.active');
            activeItems.forEach(function(item) {
                item.classList.remove('active');
            });
            document.getElementById('familyFilter').value = '';
            document.getElementById('supplierFilter').value = '';
            document.getElementById('establishmentFilter').value = '';
            document.getElementById('advancedStockFilter').value = '';
            advancedStockFilter = '';
            updateActiveButton('all');
            applyAllFilters();
        }

        function filterCriticalStock() {
            if (criticalFilterActive) {
                criticalFilterActive = false;
                currentFilter = 'all';
                updateActiveButton('all');
                applyAllFilters();
            } else {
                criticalFilterActive = true;
                currentFilter = 'critical';
                predictionFilter = null;
                const activeItems = document.querySelectorAll('.prediction-item.active');
                activeItems.forEach(function(item) {
                    item.classList.remove('active');
                });
                updateActiveButton('critical');
                applyAllFilters();
            }
        }

        function filterLowStock() {
            currentFilter = 'low';
            predictionFilter = null;
            criticalFilterActive = false;
            const activeItems = document.querySelectorAll('.prediction-item.active');
            activeItems.forEach(function(item) {
                item.classList.remove('active');
            });
            updateActiveButton('low');
            applyAllFilters();
        }

        function filterHighStock() {
            currentFilter = 'high';
            predictionFilter = null;
            criticalFilterActive = false;
            const activeItems = document.querySelectorAll('.prediction-item.active');
            activeItems.forEach(function(item) {
                item.classList.remove('active');
            });
            updateActiveButton('high');
            applyAllFilters();
        }

        function filterByFamily() {
            const familyDropdown = document.getElementById('familyFilter');
            selectedFamily = familyDropdown.value;
            criticalFilterActive = false;
            applyAllFilters();
        }

        function filterBySupplier() {
            const supplierDropdown = document.getElementById('supplierFilter');
            selectedSupplier = supplierDropdown.value;
            criticalFilterActive = false;
            applyAllFilters();
        }

        function filterByEstablishment() {
            currentEstablishment = document.getElementById('establishmentFilter').value;
            criticalFilterActive = false;
            applyAllFilters();
        }

        function filterByAdvancedStock() {
            const advancedDropdown = document.getElementById('advancedStockFilter');
            advancedStockFilter = advancedDropdown ? advancedDropdown.value : '';
            criticalFilterActive = false;
            applyAllFilters();
        }

        function filterByGauge(family) {
            if (selectedFamily === family) {
                selectedFamily = null;
                document.getElementById('familyFilter').value = '';
                showAllProducts();
            } else {
                selectedFamily = family;
                document.getElementById('familyFilter').value = family;
                filterByFamily();
            }
        }

        function filterZeroIn30() {
            const item30 = document.querySelector('.prediction-item.clickable[onclick="filterZeroIn30()"]');
            
            if (predictionFilter === 'zero30') {
                predictionFilter = null;
                item30.classList.remove('active');
                showAllProducts();
            } else {
                const activeItems = document.querySelectorAll('.prediction-item.active');
                activeItems.forEach(function(item) {
                    item.classList.remove('active');
                });
                
                predictionFilter = 'zero30';
                criticalFilterActive = false;
                item30.classList.add('active');
                currentFilter = 'prediction30';
                updateActiveButton(null);
                
                applyAllFilters();
            }
        }

        function filterZeroIn60() {
            const item60 = document.querySelector('.prediction-item.clickable[onclick="filterZeroIn60()"]');

            if (predictionFilter === 'zero60') {
                predictionFilter = null;
                item60.classList.remove('active');
                showAllProducts();
            } else {
                const activeItems = document.querySelectorAll('.prediction-item.active');
                activeItems.forEach(function(item) {
                    item.classList.remove('active');
                });

                predictionFilter = 'zero60';
                criticalFilterActive = false;
                item60.classList.add('active');
                currentFilter = 'prediction60';
                updateActiveButton(null);

                applyAllFilters();
            }
        }

        function productMatchesFilters(product, options) {
            options = options || {};

            const ignoreFamily = !!options.ignoreFamily;
            const predictionSettings = options.predictionSettings || getPredictionSettings();
            const urgentDays = predictionSettings.urgentDays;
            const warningDays = predictionSettings.warningDays;
            const coverage = getCoverageInfo(product);
            const stockAvailable = coverage.stockAvailable;

            if (predictionFilter === 'zero30') {
                if (!coverage.outOfStock) {
                    if (coverage.daysToDepletion === null) {
                        return false;
                    }
                    if (coverage.daysToDepletion > urgentDays) {
                        return false;
                    }
                }
            } else if (predictionFilter === 'zero60') {
                if (coverage.outOfStock) {
                    return false;
                }
                if (coverage.daysToDepletion === null) {
                    return false;
                }
                if (coverage.daysToDepletion <= urgentDays) {
                    return false;
                }
                if (coverage.daysToDepletion > warningDays) {
                    return false;
                }
            } else {
                switch (currentFilter) {
                    case 'critical':
                        if (!(product.stockMonths < 2)) {
                            return false;
                        }
                        break;
                    case 'low':
                        if (!(product.stockMonths >= 2 && product.stockMonths < 6)) {
                            return false;
                        }
                        break;
                    case 'high':
                        if (!(product.stockMonths >= 6)) {
                            return false;
                        }
                        break;
                }
            }

            if (searchTerm) {
                const term = searchTerm;
                const matchesSearch = product.code.toLowerCase().includes(term) ||
                    product.item.toLowerCase().includes(term) ||
                    product.supplier.toLowerCase().includes(term) ||
                    product.family.toLowerCase().includes(term);

                if (!matchesSearch) {
                    return false;
                }
            }

            if (!ignoreFamily && selectedFamily && product.family !== selectedFamily) {
                return false;
            }

            if (selectedSupplier && product.supplier !== selectedSupplier) {
                return false;
            }

            if (currentEstablishment) {
                if (advancedStockFilter === 'no-stock') {
                    if (stockAvailable > 0) {
                        return false;
                    }
                } else {
                    if (stockAvailable <= 0) {
                        return false;
                    }

                    if (advancedStockFilter === 'over50') {
                        const monthsCoverage = coverage.daysToDepletion !== null
                            ? (coverage.daysToDepletion / 30)
                            : product.stockMonths;

                        if (!(monthsCoverage > 50)) {
                            return false;
                        }
                    }
                }
            } else if (advancedStockFilter) {
                if (advancedStockFilter === 'no-stock') {
                    if (stockAvailable > 0) {
                        return false;
                    }
                } else if (advancedStockFilter === 'over50') {
                    const monthsCoverage = coverage.daysToDepletion !== null
                        ? (coverage.daysToDepletion / 30)
                        : product.stockMonths;

                    if (!(monthsCoverage > 50)) {
                        return false;
                    }
                }
            }

            return true;
        }

        function applyAllFilters() {
            const predictionSettings = getPredictionSettings();

            filteredData = allProductsData.filter(function(product) {
                return productMatchesFilters(product, { predictionSettings });
            });

            updateParetoAnalysis();
            updateTable();
            updateSummary();
            updateGauges();
            updatePredictiveAnalysis();
        }
        function updateActiveButton(filter) {
            const filterBtns = document.querySelectorAll('.filter-btn');
            filterBtns.forEach(function(btn) {
                btn.classList.remove('active');
                if (filter && btn.dataset.filter === filter) {
                    btn.classList.add('active');
                }
            });
        }

        // === FUN√á√ïES DE AN√ÅLISE ===
        function updatePredictiveAnalysis() {
            applyPredictionLabels();

            const { urgentDays, warningDays } = getPredictionSettings();
            let urgentCount = 0;
            let warningCount = 0;

            filteredData.forEach(function(product) {
                const coverage = getCoverageInfo(product);

                if (coverage.outOfStock) {
                    urgentCount++;
                    return;
                }

                if (coverage.daysToDepletion === null) {
                    return;
                }

                if (coverage.daysToDepletion <= urgentDays) {
                    urgentCount++;
                } else if (coverage.daysToDepletion <= warningDays) {
                    warningCount++;
                }
            });

            const zeroIn30Element = document.getElementById('zeroIn30');
            const zeroIn60Element = document.getElementById('zeroIn60');

            if (zeroIn30Element) {
                zeroIn30Element.textContent = urgentCount;
                zeroIn30Element.className = urgentCount > 0
                    ? 'prediction-value prediction-critical'
                    : 'prediction-value prediction-good';
            }

            if (zeroIn60Element) {
                zeroIn60Element.textContent = warningCount;
                zeroIn60Element.className = warningCount > 0
                    ? 'prediction-value prediction-warning'
                    : 'prediction-value prediction-good';
            }
        }
        function updateSummary() {
            const total = filteredData.length;
            const monthsValues = filteredData
                .map(function(p) { return typeof p.stockMonths === 'number' ? p.stockMonths : null; })
                .filter(function(value) { return value !== null && !Number.isNaN(value); })
                .sort(function(a, b) { return a - b; });

            const sumMonths = monthsValues.reduce(function(sum, value) {
                return sum + value;
            }, 0);

            const avgStock = monthsValues.length > 0 ? sumMonths / monthsValues.length : 0;
            const criticalCount = filteredData.filter(function(p) {
                return p.stockMonths < 2;
            }).length;
            const families = new Set(filteredData.map(function(p) {
                return p.family;
            })).size;

            function percentile(arr, fraction) {
                if (arr.length === 0) return null;
                const position = (arr.length - 1) * fraction;
                const base = Math.floor(position);
                const rest = position - base;
                const baseValue = arr[base];
                const nextValue = arr[base + 1];
                if (typeof nextValue === 'undefined') {
                    return baseValue;
                }
                return baseValue + rest * (nextValue - baseValue);
            }

            const median = percentile(monthsValues, 0.5);
            const q1 = percentile(monthsValues, 0.25);
            const q3 = percentile(monthsValues, 0.75);
            const variance = monthsValues.length > 0 ? monthsValues.reduce(function(acc, value) {
                return acc + Math.pow(value - avgStock, 2);
            }, 0) / monthsValues.length : 0;
            const stdDev = monthsValues.length > 0 ? Math.sqrt(variance) : null;

            document.getElementById('totalProducts').textContent = total;
            document.getElementById('avgStockMonths').textContent = monthsValues.length > 0 ? formatStatValue(avgStock) : '--';
            document.getElementById('medianStock').textContent = median !== null ? formatStatValue(median) : '--';
            document.getElementById('q1Stock').textContent = q1 !== null ? formatStatValue(q1) : '--';
            document.getElementById('q3Stock').textContent = q3 !== null ? formatStatValue(q3) : '--';
            document.getElementById('stdDevStock').textContent = stdDev !== null ? formatStatValue(stdDev) : '--';
            document.getElementById('criticalCount').textContent = criticalCount;
            document.getElementById('totalFamilies').textContent = families;
        }

        function updateParetoAnalysis() {
            const container = document.getElementById('paretoContent');
            abcClassificationMap = new Map();
            if (!container) {
                return;
            }

            if (!Array.isArray(filteredData) || filteredData.length === 0) {
                container.innerHTML = '<p class="pareto-empty">Nenhum produto para an√°lise.</p>';
                abcClassificationMap = new Map();
                return;
            }

            const sortedData = filteredData.slice().sort(function(a, b) {
                return (b.vendas4M || 0) - (a.vendas4M || 0);
            });
            const totalSales = sortedData.reduce(function(sum, product) {
                return sum + (product.vendas4M || 0);
            }, 0);

            if (totalSales === 0) {
                sortedData.forEach(function(product) {
                    abcClassificationMap.set(product.code, '‚Äî');
                });
                container.innerHTML = '<p class="pareto-empty">Sem dados de vendas para calcular a an√°lise ABC.</p>';
                return;
            }

            let cumulativeShare = 0;
            const displayLimit = 10;
            const rows = [];

            sortedData.forEach(function(product, index) {
                const sales = product.vendas4M || 0;
                const individualShare = sales / totalSales;
                cumulativeShare += individualShare;

                let classification = 'C';
                if (cumulativeShare <= 0.8) {
                    classification = 'A';
                } else if (cumulativeShare <= 0.95) {
                    classification = 'B';
                }

                abcClassificationMap.set(product.code, classification);

                if (index < displayLimit) {
                    rows.push(`
                        <tr>
                            <td>${index + 1}</td>
                            <td>${product.code}</td>
                            <td>${product.item}</td>
                            <td>${(product.vendas4M || 0).toLocaleString()}</td>
                            <td>${(individualShare * 100).toFixed(1)}%</td>
                            <td>${(cumulativeShare * 100).toFixed(1)}%</td>
                            <td><span class="abc-chip abc-${classification.toLowerCase()}">${classification}</span></td>
                        </tr>
                    `);
                }
            });

            const tableHtml = `
                <table class="pareto-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>C√≥digo</th>
                            <th>Item</th>
                            <th>Vendas 4M
                                <span class="tooltip-container info-tooltip" tabindex="0" aria-label="Vendas nos √∫ltimos quatro meses">
                                    <span class="info-tooltip-icon" aria-hidden="true">?</span>
                                    <span class="tooltip-bubble">Volume total vendido no per√≠odo de quatro meses usado como base para a curva ABC.</span>
                                </span>
                            </th>
                            <th>% Individual
                                <span class="tooltip-container info-tooltip" tabindex="0" aria-label="Participa√ß√£o individual">
                                    <span class="info-tooltip-icon" aria-hidden="true">?</span>
                                    <span class="tooltip-bubble">Percentual da venda do item em rela√ß√£o ao total analisado. Indica o peso de cada produto individualmente.</span>
                                </span>
                            </th>
                            <th>% Acumulado
                                <span class="tooltip-container info-tooltip" tabindex="0" aria-label="Participa√ß√£o acumulada">
                                    <span class="info-tooltip-icon" aria-hidden="true">?</span>
                                    <span class="tooltip-bubble">Soma progressiva das participa√ß√µes individuais. Define os limites de corte das classes A (at√© ~80%), B (at√© ~95%) e C.</span>
                                </span>
                            </th>
                            <th>Classe
                                <span class="tooltip-container info-tooltip" tabindex="0" aria-label="Classe ABC do item">
                                    <span class="info-tooltip-icon" aria-hidden="true">?</span>
                                    <span class="tooltip-bubble">Etiqueta resultante da participa√ß√£o acumulada: A (mais relevante), B (intermedi√°ria) ou C (menor impacto).</span>
                                </span>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        ${rows.join('')}
                    </tbody>
                </table>
            `;

            const footer = sortedData.length > displayLimit
                ? `<p class="pareto-empty">Exibindo top ${displayLimit} de ${sortedData.length} produtos.</p>`
                : '';

            container.innerHTML = tableHtml + footer;
        }

        function updateTable() {
            const tableBody = document.getElementById('productsTableBody');
            tableBody.innerHTML = '';

            filteredData.forEach(function(product) {
                const row = document.createElement('tr');
                const stock14Value = toFiniteNumber(product.stock14);
                const stock9013Value = toFiniteNumber(product.stock9013);
                const stock9015Value = toFiniteNumber(product.stock9015);
                const monthsValue = toFiniteNumber(product.stockMonths);
                const vendas4MValue = toFiniteNumber(product.vendas4M);
                const media3MValue = toFiniteNumber(product.media3M);
                const hasStockData = stock14Value !== null || stock9013Value !== null || stock9015Value !== null;
                const totalStockValue = hasStockData
                    ? (stock14Value === null ? 0 : stock14Value)
                        + (stock9013Value === null ? 0 : stock9013Value)
                        + (stock9015Value === null ? 0 : stock9015Value)
                    : null;
                const statusClass = getStatusClass(monthsValue);
                const statusText = getStatusText(monthsValue);
                const predictionInfo = getPrediction(product);
                const predictionClass = predictionInfo && predictionInfo.severity
                    ? `status-${predictionInfo.severity}`
                    : statusClass;
                const predictionLabel = predictionInfo && typeof predictionInfo === 'object'
                    ? predictionInfo.label
                    : predictionInfo;
                const predictionTooltip = predictionInfo && typeof predictionInfo === 'object'
                    ? predictionInfo.tooltip || predictionInfo.fullText
                    : predictionInfo;
                const predictionDisplay = predictionLabel
                    ? `<span class="tooltip-container tooltip-chip" tabindex="0">
                            ${escapeHtml(predictionLabel)}
                            <span class="tooltip-hint" aria-hidden="true">‚ìò</span>
                            <span class="tooltip-bubble">${escapeHtml(predictionTooltip || predictionLabel)}</span>
                        </span>`
                    : '--';

                const vendas4MDisplay = vendas4MValue === null
                    ? '--'
                    : (vendas4MValue === 0 ? 'S/ VENDA' : vendas4MValue.toLocaleString());
                const vendas4MClass = vendas4MValue === null
                    ? ''
                    : (vendas4MValue === 0 ? 'status-warning' : '');

                const abcClass = abcClassificationMap.get(product.code);
                const normalizedAbcClass = (typeof abcClass === 'string' && abcClass) ? abcClass.toUpperCase() : '‚Äî';
                const abcCellContent = normalizedAbcClass === '‚Äî'
                    ? '‚Äî'
                    : `<span class="abc-chip abc-${normalizedAbcClass.toLowerCase()}">${normalizedAbcClass}</span>`;

                const monthsDisplay = formatStatValue(monthsValue);
                const totalStockDisplay = totalStockValue === null ? '--' : formatIntegerValue(totalStockValue);
                const stock14Display = formatIntegerValue(stock14Value);
                const stock9013Display = formatIntegerValue(stock9013Value);
                const stock9015Display = formatIntegerValue(stock9015Value);
                const media3MDisplay = media3MValue === null ? '--' : Math.round(media3MValue).toLocaleString();

                const codeDisplay = escapeHtml(product.code);
                const supplierDisplay = escapeHtml(product.supplier);
                const familyDisplay = escapeHtml(product.family);
                const itemDisplay = escapeHtml(product.item);

                row.innerHTML = `
                    <td>${codeDisplay}</td>
                    <td>${supplierDisplay}</td>
                    <td>${familyDisplay}</td>
                    <td>${itemDisplay}</td>
                    <td>${stock14Display}</td>
                    <td>${stock9013Display}</td>
                    <td>${stock9015Display}</td>
                    <td><strong>${totalStockDisplay}</strong></td>
                    <td class="${vendas4MClass}">${vendas4MDisplay}</td>
                    <td>${media3MDisplay}</td>
                    <td class="${statusClass}">${monthsDisplay}</td>
                    <td class="${predictionClass}">${predictionDisplay}</td>
                    <td class="${statusClass}">${escapeHtml(statusText)}</td>
                    <td>${abcCellContent}</td>

                `;

                if (normalizedAbcClass === 'A') {
                    row.classList.add('abc-row-a');
                } else if (normalizedAbcClass === 'B') {
                    row.classList.add('abc-row-b');
                } else if (normalizedAbcClass === 'C') {
                    row.classList.add('abc-row-c');
                }

                row.dataset.abcClass = normalizedAbcClass;

                tableBody.appendChild(row);
            });

            document.getElementById('tableCount').textContent = `${filteredData.length} produtos exibidos`;

            if (searchTerm) {
                highlightSearchResults();
            }
        }

        function getProductStock(product) {
            const stock14 = toFiniteNumber(product.stock14);
            const stock9013 = toFiniteNumber(product.stock9013);
            const stock9015 = toFiniteNumber(product.stock9015);

            const value14 = stock14 === null ? 0 : stock14;
            const value9013 = stock9013 === null ? 0 : stock9013;
            const value9015 = stock9015 === null ? 0 : stock9015;

            switch(currentEstablishment) {
                case '1-4': return value14;
                case '90-13': return value9013;
                case '90-15': return value9015;
                default: return value14 + value9013 + value9015;
            }
        }

        function getPrediction(product) {
            const coverage = getCoverageInfo(product);
            const { urgentDays, warningDays } = getPredictionSettings();

            if (coverage.outOfStock) {
                const message = 'Sem estoque ‚Äî ruptura imediata';
                return {
                    label: 'Sem estoque',
                    tooltip: message,
                    severity: 'critical',
                    fullText: message
                };
            }

            if (!coverage.hasDemand || coverage.daysToDepletion === null) {
                const message = 'Sem demanda recente ‚Äî cobertura indefinida';
                return {
                    label: 'Sem demanda',
                    tooltip: message,
                    severity: 'warning',
                    fullText: message
                };
            }

            const daysToDepletion = Math.max(1, Math.round(coverage.daysToDepletion));
            const estimatedDate = new Date(Date.now() + daysToDepletion * 86400000);
            const formattedDate = estimatedDate.toLocaleDateString('pt-BR');
            const monthsCoverage = coverage.daysToDepletion / 30;
            const formattedMonths = formatStatValue(monthsCoverage);

            if (daysToDepletion <= urgentDays) {
                const tooltip = `Cr√≠tico ‚Äî ${daysToDepletion} dias de cobertura (ruptura estimada em ${formattedDate})`;
                return {
                    label: `Cr√≠tico (${daysToDepletion}d)`,
                    tooltip,
                    severity: 'critical',
                    fullText: `Cr√≠tico ‚Äî ${daysToDepletion} dias (ruptura em ${formattedDate})`
                };
            }

            if (daysToDepletion <= warningDays) {
                const tooltip = `Aten√ß√£o ‚Äî ${daysToDepletion} dias de cobertura (ruptura estimada em ${formattedDate})`;
                return {
                    label: `Aten√ß√£o (${daysToDepletion}d)`,
                    tooltip,
                    severity: 'warning',
                    fullText: `Aten√ß√£o ‚Äî ${daysToDepletion} dias (ruptura em ${formattedDate})`
                };
            }

            const tooltip = `Est√°vel ‚Äî ${formattedMonths} meses de cobertura (ruptura estimada em ${formattedDate})`;
            return {
                label: `Est√°vel (${formattedMonths}m)`,
                tooltip,
                severity: 'good',
                fullText: `Est√°vel ‚Äî ${formattedMonths} meses (ruptura em ${formattedDate})`
            };
        }

        function getStatusClass(months) {
            if (!(typeof months === 'number' && Number.isFinite(months))) {
                return 'status-unknown';
            }

            if (months < 2) return 'status-critical';
            if (months < 6) return 'status-warning';
            return 'status-good';
        }

        function getStatusText(months) {
            if (!(typeof months === 'number' && Number.isFinite(months))) {
                return 'Indefinido';
            }

            if (months < 2) return 'Cr√≠tico';
            if (months < 6) return 'Aten√ß√£o';
            return 'Bom';
        }

        // === FUN√á√ïES DE GAUGES ===
        function updateGauges() {
            const families = [...new Set(allProductsData.map(function(p) {
                return p.family;
            }))].sort();
            const container = document.getElementById('gaugesContainer');
            container.innerHTML = '';

            families.forEach(function(family, index) {
                const familyProducts = getFamilyFilteredProducts(family);
                if (familyProducts.length === 0) return;
                
                const avgStock = calculateAverageStock(familyProducts);
                const criticalCount = familyProducts.filter(function(p) {
                    const hasStock = currentEstablishment ? 
                        getProductStock(p) > 0 : 
                        (p.stock14 + p.stock9013 + p.stock9015) > 0;
                    return hasStock && p.stockMonths < 2;
                }).length;

                const card = document.createElement('div');
                card.className = 'gauge-card';
                
                if (selectedFamily === family) {
                    card.classList.add('selected');
                }
                
                const shouldHighlight = searchTerm && family.toLowerCase().includes(searchTerm);
                if (shouldHighlight) {
                    card.classList.add('highlighted');
                }

                card.onclick = function() {
                    filterByGauge(family);
                };
                card.style.cursor = 'pointer';
                card.title = `Clique para filtrar produtos da fam√≠lia ${family}`;

                card.innerHTML = `
                    <div class="gauge-title">${family}</div>
                    <div class="gauge">
                        <canvas id="gauge${index}" width="240" height="140"></canvas>
                        <div class="gauge-value">${avgStock.toFixed(1)}</div>
                        <div class="gauge-label">meses</div>
                    </div>
                    <div style="text-align: center; margin-top: 10px; font-size: 12px; color: #666;">
                        ${familyProducts.length} produtos | ${criticalCount} cr√≠ticos
                    </div>
                `;
                container.appendChild(card);

                setTimeout(function() {
                    card.classList.add('animating');
                }, index * 100);

                drawGauge(`gauge${index}`, avgStock, family, index * 200);
            });
        }

        function getFamilyFilteredProducts(family) {
            if (selectedFamily && selectedFamily !== family) {
                return [];
            }

            const predictionSettings = getPredictionSettings();

            return allProductsData.filter(function(p) {
                if (p.family !== family) {
                    return false;
                }

                return productMatchesFilters(p, {
                    ignoreFamily: true,
                    predictionSettings
                });
            });
        }

        function calculateAverageStock(products) {
            if (products.length === 0) return 0;
            return products.reduce(function(sum, p) {
                return sum + p.stockMonths;
            }, 0) / products.length;
        }

        function drawGauge(canvasId, value, title, delay) {
            delay = delay || 0;
            setTimeout(function() {
                const canvas = document.getElementById(canvasId);
                if (!canvas) return;
                
                const ctx = canvas.getContext('2d');
                const centerX = canvas.width / 2;
                const centerY = canvas.height - 25;
                const radius = 90;

                ctx.clearRect(0, 0, canvas.width, canvas.height);

                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, Math.PI, 0);
                ctx.lineWidth = 20;
                ctx.strokeStyle = '#e0e0e0';
                ctx.stroke();

                let color;
                if (value < 3) {
                    color = '#f44336';
                } else if (value < 6) {
                    color = '#ff9800';
                } else {
                    color = '#4caf50';
                }

                const maxValue = 12;
                const targetAngle = Math.min(value / maxValue, 1) * Math.PI;
                let currentAngle = 0;
                const animationDuration = 1000;
                const startTime = Date.now();

                function animate() {
                    const elapsed = Date.now() - startTime;
                    const progress = Math.min(elapsed / animationDuration, 1);
                    currentAngle = targetAngle * progress;

                    ctx.clearRect(0, 0, canvas.width, canvas.height);

                    ctx.beginPath();
                    ctx.arc(centerX, centerY, radius, Math.PI, 0);
                    ctx.lineWidth = 20;
                    ctx.strokeStyle = '#e0e0e0';
                    ctx.stroke();

                    if (currentAngle > 0) {
                        ctx.beginPath();
                        ctx.arc(centerX, centerY, radius, Math.PI, Math.PI + currentAngle);
                        ctx.lineWidth = 20;
                        ctx.strokeStyle = color;
                        ctx.stroke();
                    }

                    drawGaugeMarks(ctx, centerX, centerY, radius);

                    if (progress < 1) {
                        requestAnimationFrame(animate);
                    }
                }

                animate();
            }, delay);
        }

        function drawGaugeMarks(ctx, centerX, centerY, radius) {
            for (let i = 0; i <= 12; i += 3) {
                const markAngle = Math.PI + (i / 12) * Math.PI;
                const x1 = centerX + Math.cos(markAngle) * (radius - 30);
                const y1 = centerY + Math.sin(markAngle) * (radius - 30);
                const x2 = centerX + Math.cos(markAngle) * (radius - 10);
                const y2 = centerY + Math.sin(markAngle) * (radius - 10);

                ctx.beginPath();
                ctx.moveTo(x1, y1);
                ctx.lineTo(x2, y2);
                ctx.lineWidth = 3;
                ctx.strokeStyle = '#333';
                ctx.stroke();

                if (i % 6 === 0) {
                    const textX = centerX + Math.cos(markAngle) * (radius - 45);
                    const textY = centerY + Math.sin(markAngle) * (radius - 45);
                    ctx.fillStyle = '#333';
                    ctx.font = 'bold 14px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(i.toString(), textX, textY + 5);
                }
            }
        }

        // === FUN√á√ïES DE EXPORTA√á√ÉO ===
        function showExportModal() {
            const modal = document.getElementById('exportModal');
            const currentDate = new Date().toISOString().split('T')[0];
            document.getElementById('fileName').value = `estoque_preditivo_${currentDate}`;
            modal.style.display = 'block';
        }

        function closeExportModal() {
            document.getElementById('exportModal').style.display = 'none';
        }

        function confirmExport() {
            const fileName = document.getElementById('fileName').value || 'estoque_dados';
            const fileFormat = document.getElementById('fileFormat').value;
            
            const exportData = filteredData.map(function(p) {
                const predictionInfo = getPrediction(p);
                const predictionText = predictionInfo && typeof predictionInfo === 'object'
                    ? predictionInfo.fullText
                    : predictionInfo;
                return {
                    'C√ìDIGO': p.code,
                    'FORNECEDOR': p.supplier,
                    'FAM√çLIA': p.family,
                    'ITEM': p.item,
                    'ESTOQUE 1-4': p.stock14,
                    'ESTOQUE 90-13': p.stock9013,
                    'ESTOQUE 90-15': p.stock9015,
                    'TOTAL ESTOQUE': p.stock14 + p.stock9013 + p.stock9015,
                    'VENDAS 4M': (!p.vendas4M || p.vendas4M === 0) ? 'S/ VENDA' : p.vendas4M,
                    'ESTOQUE EM MESES': p.stockMonths,
                    'PREVIS√ÉO': predictionText,
                    'STATUS': getStatusText(p.stockMonths)
                };
            });

            if (fileFormat === 'csv') {
                const csv = convertToCSV(exportData);
                downloadFile(csv, `${fileName}.csv`, 'text/csv');
            } else {
                const ws = XLSX.utils.json_to_sheet(exportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Estoque');
                XLSX.writeFile(wb, `${fileName}.xlsx`);
            }
            
            closeExportModal();
        }

        function convertToCSV(data) {
            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(',')
            ].concat(data.map(function(row) {
                return headers.map(function(header) {
                    return `"${row[header]}"`;
                }).join(',');
            })).join('\n');
            return csvContent;
        }

        function downloadFile(content, fileName, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function updateData() {
            loadData();
            showMessage('‚úÖ Dashboard atualizado!', 'success');
        }

        // Fechar modal ao clicar fora dele
        window.onclick = function(event) {
            const modal = document.getElementById('exportModal');
            if (event.target === modal) {
                closeExportModal();
            }
        }

        // Carregar arquivo de dados externo
        function loadExternalDataScript() {
            debugLog('Carregando data.js externo...');
            
            const script = document.createElement('script');
            script.src = 'data.js';
            script.onerror = function() {
                debugLog('Arquivo data.js n√£o encontrado, usando localStorage ou dados vazios');
                loadData();
            };
            script.onload = function() {
                debugLog('Arquivo data.js carregado com sucesso');
                setTimeout(function() {
                    loadData();
                }, 100);
            };
            document.head.appendChild(script);
        }

        // === INICIALIZA√á√ÉO ===
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('=== INICIALIZA√á√ÉO DO DASHBOARD v1.2 ===');
            debugLog('DOM carregado, iniciando processo...');
            
            try {
                // Primeiro detectar capacidades do navegador
                detectBrowserCapabilities();
                applyPredictionLabels();

                // Depois carregar dados
                loadExternalDataScript();
                
                // Configura√ß√µes iniciais ap√≥s carregar
                setTimeout(function() {
                    updateUI();
                    
                    // Se n√£o h√° dados, abrir automaticamente a se√ß√£o de importa√ß√£o
                    if (allProductsData.length === 0) {
                        debugLog('Nenhum dado encontrado, se√ß√£o de importa√ß√£o j√° est√° aberta');
                    }
                }, 1500);
                
            } catch (error) {
                debugLog(`Erro na inicializa√ß√£o: ${error.message}`, 'error');
                // Fallback: tentar carregar dados mesmo com erro
                try {
                    loadData();
                } catch (e) {
                    debugLog(`Erro no fallback: ${e.message}`, 'error');
                    showMessage('‚ùå Erro ao inicializar dashboard. Use o diagn√≥stico para mais detalhes.', 'error');
                }
            }
        });

        // Adicionar event listeners para inputs
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('globalSearch');
            if (searchInput) {
                // Throttle para melhor performance
                let searchTimeout;
                searchInput.addEventListener('input', function() {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(performGlobalSearch, 300);
                });
            }
        });

        // Detectar mudan√ßas no localStorage (para sincroniza√ß√£o entre abas)
        window.addEventListener('storage', function(e) {
            if (e.key === 'stockData') {
                debugLog('Detectada mudan√ßa nos dados do localStorage');
                loadData();
            }
        });

        // Log de informa√ß√µes do sistema ao carregar
        console.log(`
üöÄ DASHBOARD DE ESTOQUE v1.2 - MAPEAMENTO CORRIGIDO
===================================================
üìÖ Data: ${new Date().toLocaleString('pt-BR')}
üåê Navegador: ${navigator.userAgent}
üîç URL: ${window.location.href}
üîë Protocolo: ${window.location.protocol}
üíª Tela: ${screen.width}x${screen.height}
üì± Viewport: ${window.innerWidth}x${window.innerHeight}
üîß Debug: Use toggleDebug() para ativar logs detalhados
üìã Mapeamento: Use toggleMappingDebug() para ver mapeamento de colunas
===================================================
‚ú® CORRE√á√ïES v1.2:
- Mapeamento de colunas aprimorado
- Detec√ß√£o de colunas TOTAL/SOMA corrigida
- Debug de mapeamento adicionado
- Avisos de mapeamento incorreto
===================================================
        `);
    </script>
</body>
</html>
